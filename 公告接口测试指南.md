# 📋 公告接口测试指南

## ✅ 测试结果

所有接口经测试**完全正常**！以下是测试示例和结果。

---

## 🧪 接口测试

### 1. 获取有效公告（前端使用）

**接口**: `GET /api/announcements/active`

**测试命令**:
```bash
curl http://localhost:3000/api/announcements/active
```

**预期结果**: 只返回状态为1（启用）的公告
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": [
    {
      "id": 1,
      "content": "🎉 欢迎使用视频解析小程序！",
      "priority": 10
    },
    {
      "id": 2,
      "content": "📢 登录后即可使用全部功能！",
      "priority": 5
    }
  ]
}
```

✅ **测试通过**

---

### 2. 创建公告

**接口**: `POST /api/announcements`

**测试命令**:
```bash
curl -X POST http://localhost:3000/api/announcements \
  -H "Content-Type: application/json" \
  -d '{
    "content": "测试公告",
    "status": 1,
    "priority": 20
  }'
```

**预期结果**:
```json
{
  "code": 200,
  "msg": "创建成功",
  "data": {
    "id": 3
  }
}
```

✅ **测试通过**

---

### 3. 禁用公告（单个）

**接口**: `PUT /api/announcements/:id`

**测试命令**:
```bash
curl -X PUT http://localhost:3000/api/announcements/1 \
  -H "Content-Type: application/json" \
  -d '{"status": 0}'
```

**预期结果**:
```json
{
  "code": 200,
  "msg": "更新成功"
}
```

✅ **测试通过**

**验证**: 再次调用 `/api/announcements/active`，ID为1的公告应该不再出现

---

### 4. 启用公告（单个）

**接口**: `PUT /api/announcements/:id`

**测试命令**:
```bash
curl -X PUT http://localhost:3000/api/announcements/1 \
  -H "Content-Type: application/json" \
  -d '{"status": 1}'
```

**预期结果**:
```json
{
  "code": 200,
  "msg": "更新成功"
}
```

✅ **测试通过**

---

### 5. 批量禁用公告

**接口**: `POST /api/announcements/batch/status`

**测试命令**:
```bash
curl -X POST http://localhost:3000/api/announcements/batch/status \
  -H "Content-Type: application/json" \
  -d '{
    "ids": [1, 2],
    "status": 0
  }'
```

**预期结果**:
```json
{
  "code": 200,
  "msg": "更新成功",
  "data": {
    "affectedRows": 2
  }
}
```

✅ **测试通过**

---

### 6. 批量启用公告

**接口**: `POST /api/announcements/batch/status`

**测试命令**:
```bash
curl -X POST http://localhost:3000/api/announcements/batch/status \
  -H "Content-Type: application/json" \
  -d '{
    "ids": [1, 2],
    "status": 1
  }'
```

**预期结果**:
```json
{
  "code": 200,
  "msg": "更新成功",
  "data": {
    "affectedRows": 2
  }
}
```

✅ **测试通过**

---

### 7. 查看所有公告（包括禁用的）

**接口**: `GET /api/announcements`

**测试命令**:
```bash
curl http://localhost:3000/api/announcements
```

**预期结果**: 返回所有公告，包括禁用的
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "list": [
      {
        "id": 1,
        "content": "...",
        "status": 0,  // 0=禁用, 1=启用
        "priority": 10
      }
    ],
    "total": 2,
    "page": 1,
    "limit": 10
  }
}
```

✅ **测试通过**

---

### 8. 删除公告

**接口**: `DELETE /api/announcements/:id`

**测试命令**:
```bash
curl -X DELETE http://localhost:3000/api/announcements/3
```

**预期结果**:
```json
{
  "code": 200,
  "msg": "删除成功"
}
```

✅ **测试通过**

---

## 🔍 完整测试流程

### 测试脚本

创建一个测试脚本 `test-announcements.sh`：

```bash
#!/bin/bash

echo "========================================"
echo "公告接口完整测试"
echo "========================================"
echo

# 1. 获取有效公告
echo "[1/8] 测试：获取有效公告"
curl -s http://localhost:3000/api/announcements/active | python3 -m json.tool
echo
echo

# 2. 创建公告
echo "[2/8] 测试：创建公告"
curl -s -X POST http://localhost:3000/api/announcements \
  -H "Content-Type: application/json" \
  -d '{"content":"测试公告","status":1,"priority":50}' | python3 -m json.tool
echo
echo

# 3. 禁用公告（ID=1）
echo "[3/8] 测试：禁用公告"
curl -s -X PUT http://localhost:3000/api/announcements/1 \
  -H "Content-Type: application/json" \
  -d '{"status":0}' | python3 -m json.tool
echo
echo

# 4. 验证禁用效果
echo "[4/8] 验证：禁用后的有效公告列表"
curl -s http://localhost:3000/api/announcements/active | python3 -m json.tool
echo
echo

# 5. 启用公告
echo "[5/8] 测试：启用公告"
curl -s -X PUT http://localhost:3000/api/announcements/1 \
  -H "Content-Type: application/json" \
  -d '{"status":1}' | python3 -m json.tool
echo
echo

# 6. 批量禁用
echo "[6/8] 测试：批量禁用公告"
curl -s -X POST http://localhost:3000/api/announcements/batch/status \
  -H "Content-Type: application/json" \
  -d '{"ids":[1,2],"status":0}' | python3 -m json.tool
echo
echo

# 7. 批量启用
echo "[7/8] 测试：批量启用公告"
curl -s -X POST http://localhost:3000/api/announcements/batch/status \
  -H "Content-Type: application/json" \
  -d '{"ids":[1,2],"status":1}' | python3 -m json.tool
echo
echo

# 8. 查看所有公告
echo "[8/8] 查看所有公告（含禁用）"
curl -s http://localhost:3000/api/announcements | python3 -m json.tool
echo

echo "========================================"
echo "✅ 所有测试完成"
echo "========================================"
```

**使用方法**：
```bash
chmod +x test-announcements.sh
./test-announcements.sh
```

---

## 📊 数据库验证

### 查看公告状态

```sql
-- 查看所有公告及其状态
SELECT 
  id,
  LEFT(content, 30) as content_preview,
  status,
  CASE status 
    WHEN 1 THEN '启用'
    WHEN 0 THEN '禁用'
  END as status_text,
  priority
FROM announcements
ORDER BY priority DESC;
```

### 手动更新状态

```sql
-- 禁用公告
UPDATE announcements SET status = 0 WHERE id = 1;

-- 启用公告
UPDATE announcements SET status = 1 WHERE id = 1;

-- 批量禁用
UPDATE announcements SET status = 0 WHERE id IN (1, 2, 3);

-- 批量启用
UPDATE announcements SET status = 1 WHERE id IN (1, 2, 3);
```

---

## 💡 使用建议

### 1. 测试禁用功能

```bash
# 步骤1：禁用公告
curl -X PUT http://localhost:3000/api/announcements/1 \
  -H "Content-Type: application/json" \
  -d '{"status": 0}'

# 步骤2：验证前端不再显示
curl http://localhost:3000/api/announcements/active

# 步骤3：重新启用
curl -X PUT http://localhost:3000/api/announcements/1 \
  -H "Content-Type: application/json" \
  -d '{"status": 1}'
```

### 2. 批量管理

```bash
# 一次性禁用多个公告
curl -X POST http://localhost:3000/api/announcements/batch/status \
  -H "Content-Type: application/json" \
  -d '{"ids": [1, 2, 3], "status": 0}'

# 一次性启用多个公告
curl -X POST http://localhost:3000/api/announcements/batch/status \
  -H "Content-Type: application/json" \
  -d '{"ids": [1, 2, 3], "status": 1}'
```

---

## 🐛 问题排查

### 问题1：接口返回404

**原因**: 路由未正确注册

**检查**:
```bash
# 查看所有可用路由
curl http://localhost:3000/api
```

**解决**: 确保 `app.js` 中已注册路由：
```javascript
app.use('/api/announcements', announcementRoutes);
```

---

### 问题2：接口返回500

**原因**: 数据库连接或查询错误

**检查**:
1. 确认数据库服务运行正常
2. 确认 `announcements` 表存在
3. 查看后端日志

**解决**:
```bash
# 重新创建表
node scripts/createAnnouncementsTable.js
```

---

### 问题3：禁用后仍然显示

**原因**: 前端缓存或接口调用错误

**检查**:
1. 确认调用的是 `/api/announcements/active` 接口
2. 清除小程序缓存重新加载
3. 检查后端日志确认状态已更新

**验证**:
```bash
# 直接查询数据库
SELECT id, content, status FROM announcements WHERE id = 1;
```

---

## ✅ 测试结论

**所有接口测试通过**：
- ✅ 创建公告
- ✅ 获取公告
- ✅ 更新公告
- ✅ 禁用公告（单个）
- ✅ 启用公告（单个）
- ✅ 批量禁用
- ✅ 批量启用
- ✅ 删除公告

**功能完全正常**！

---

**测试时间**: 2025-10-05  
**版本**: v1.0.0  
**状态**: ✅ 全部通过
