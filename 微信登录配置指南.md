# å¾®ä¿¡ç™»å½•é…ç½®æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ é…ç½®å¾®ä¿¡å°ç¨‹åºçš„ç™»å½•åŠŸèƒ½ã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

1. å·²æ³¨å†Œå¾®ä¿¡å°ç¨‹åºè´¦å·
2. å·²è·å–å°ç¨‹åºçš„ AppID å’Œ AppSecret
3. å·²å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆaxios, jsonwebtokenï¼‰

## ğŸ”§ åç«¯é…ç½®

### 1. é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `config/env.example` æ–‡ä»¶ï¼ˆæˆ–åˆ›å»º `.env` æ–‡ä»¶ï¼‰ï¼š

```bash
# å¾®ä¿¡å°ç¨‹åºé…ç½®
WX_APPID=your_wx_appid_here          # æ›¿æ¢ä¸ºä½ çš„å°ç¨‹åº AppID
WX_APP_SECRET=your_wx_app_secret_here # æ›¿æ¢ä¸ºä½ çš„å°ç¨‹åº AppSecret

# JWTé…ç½®
JWT_SECRET=your_jwt_secret_key_here   # ç”Ÿæˆä¸€ä¸ªéšæœºå¯†é’¥
```

#### å¦‚ä½•è·å– AppID å’Œ AppSecretï¼Ÿ

1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥"å¼€å‘" -> "å¼€å‘ç®¡ç†" -> "å¼€å‘è®¾ç½®"
3. åœ¨"å¼€å‘è€…ID"éƒ¨åˆ†æ‰¾åˆ°ï¼š
   - **AppID(å°ç¨‹åºID)**
   - **AppSecret(å°ç¨‹åºå¯†é’¥)**

> âš ï¸ **å®‰å…¨æç¤º**ï¼šAppSecret éå¸¸é‡è¦ï¼Œè¯·å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æ³„éœ²ï¼

#### ç”Ÿæˆ JWT_SECRET

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ç”Ÿæˆéšæœºå¯†é’¥ï¼š

```bash
# ä½¿ç”¨ Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# æˆ–ä½¿ç”¨ OpenSSL
openssl rand -hex 32
```

### 2. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœè¿˜æœªå®‰è£…ï¼‰

```bash
npm install axios jsonwebtoken
# æˆ–
pnpm install axios jsonwebtoken
```

### 3. å¯åŠ¨åç«¯æœåŠ¡

```bash
npm start
# æˆ–
node app.js
```

ç¡®ä¿åç«¯æœåŠ¡å¯åŠ¨åœ¨ `http://localhost:3000` æˆ–ä½ é…ç½®çš„ç«¯å£ã€‚

## ğŸ“± å‰ç«¯é…ç½®

### 1. é…ç½®æœåŠ¡å™¨åŸŸå

åœ¨å°ç¨‹åºå¼€å‘æ—¶ï¼Œéœ€è¦é…ç½®æœåŠ¡å™¨åŸŸåï¼š

#### æ–¹æ³•ä¸€ï¼šå¼€å‘é˜¶æ®µï¼ˆæ¨èï¼‰

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
1. ç‚¹å‡»å³ä¸Šè§’"è¯¦æƒ…"
2. å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸåã€web-viewï¼ˆä¸šåŠ¡åŸŸåï¼‰ã€TLS ç‰ˆæœ¬ä»¥åŠ HTTPS è¯ä¹¦"

#### æ–¹æ³•äºŒï¼šç”Ÿäº§ç¯å¢ƒ

1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥"å¼€å‘" -> "å¼€å‘ç®¡ç†" -> "å¼€å‘è®¾ç½®" -> "æœåŠ¡å™¨åŸŸå"
3. é…ç½®ä»¥ä¸‹åŸŸåï¼š
   - **requeståˆæ³•åŸŸå**ï¼šæ·»åŠ ä½ çš„åç«¯æœåŠ¡å™¨åŸŸå
   - **socketåˆæ³•åŸŸå**ï¼šå¦‚éœ€ä½¿ç”¨ WebSocketï¼Œæ·»åŠ å¯¹åº”åŸŸå
   - **uploadFileåˆæ³•åŸŸå**ï¼šå¦‚éœ€ä¸Šä¼ æ–‡ä»¶ï¼Œæ·»åŠ å¯¹åº”åŸŸå
   - **downloadFileåˆæ³•åŸŸå**ï¼šå¦‚éœ€ä¸‹è½½æ–‡ä»¶ï¼Œæ·»åŠ å¯¹åº”åŸŸå

> âš ï¸ **æ³¨æ„**ï¼šåŸŸåå¿…é¡»ä½¿ç”¨ HTTPS åè®®ï¼ˆæœ¬åœ°å¼€å‘é™¤å¤–ï¼‰

### 2. é…ç½®åç«¯ API åœ°å€

ç¼–è¾‘ `miniprogram/utils/api.js`ï¼Œç¡®ä¿ `baseUrl` é…ç½®æ­£ç¡®ï¼š

```javascript
const getConfig = () => {
  try {
    const accountInfo = wx.getAccountInfoSync()
    const systemInfo = wx.getSystemInfoSync()
    const isSimulator = systemInfo.platform === 'devtools'
    
    if (isSimulator) {
      // å¼€å‘å·¥å…·ç¯å¢ƒ
      return {
        baseUrl: 'http://localhost:3000/api',  // æœ¬åœ°å¼€å‘åœ°å€
        debug: true,
        timeout: 10000
      }
    } else {
      // çœŸæœºè°ƒè¯•ç¯å¢ƒ - è¯·ä¿®æ”¹ä¸ºæ‚¨çš„ç”µè„‘IPåœ°å€
      return {
        baseUrl: 'http://192.168.x.x:3000/api', // ä¿®æ”¹ä¸ºä½ çš„å±€åŸŸç½‘IP
        debug: true,
        timeout: 15000
      }
    }
  } catch (error) {
    console.error('è·å–ç¯å¢ƒé…ç½®å¤±è´¥:', error)
    return {
      baseUrl: 'http://localhost:3000/api',
      debug: true,
      timeout: 10000
    }
  }
}
```

> ğŸ’¡ **æç¤º**ï¼šçœŸæœºè°ƒè¯•æ—¶ï¼Œéœ€è¦å°† `192.168.x.x` æ›¿æ¢ä¸ºä½ çš„ç”µè„‘å±€åŸŸç½‘IPåœ°å€

### 3. é…ç½®å°ç¨‹åºæƒé™

åœ¨ `miniprogram/app.json` ä¸­ç¡®ä¿å·²é…ç½®å¿…è¦æƒé™ï¼š

```json
{
  "permission": {
    "scope.userLocation": {
      "desc": "ä½ çš„ä½ç½®ä¿¡æ¯å°†ç”¨äºå°ç¨‹åºä½ç½®æ¥å£çš„æ•ˆæœå±•ç¤º"
    }
  },
  "requiredPrivateInfos": [
    "getLocation",
    "chooseAddress",
    "getPhoneNumber"
  ]
}
```

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. åŸºç¡€ç™»å½•æµç¨‹ï¼ˆä¸è·å–æ‰‹æœºå·ï¼‰

```javascript
// è°ƒç”¨ç™»å½•æ–¹æ³•
const auth = require('../../utils/auth.js')

const result = await auth.login()
if (result.success) {
  console.log('ç™»å½•æˆåŠŸ:', result.data)
  // result.data åŒ…å«: token, openid, expiresIn
} else {
  console.error('ç™»å½•å¤±è´¥:', result.error)
}
```

### 2. è·å–æ‰‹æœºå·ç™»å½•æµç¨‹

åœ¨ WXML ä¸­ï¼š

```xml
<button 
  open-type="getPhoneNumber" 
  bindgetphonenumber="onGetPhoneNumber"
>
  æˆæƒæ‰‹æœºå·
</button>
```

åœ¨ JS ä¸­ï¼š

```javascript
async onGetPhoneNumber(e) {
  if (e.detail.code) {
    const phoneCode = e.detail.code
    const result = await auth.login(phoneCode)
    
    if (result.success) {
      console.log('ç™»å½•æˆåŠŸï¼Œå·²è·å–æ‰‹æœºå·:', result.data.phone)
    }
  } else {
    console.log('ç”¨æˆ·å–æ¶ˆæˆæƒ')
  }
}
```

### 3. æ£€æŸ¥ç™»å½•çŠ¶æ€

```javascript
const auth = require('../../utils/auth.js')

// æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
if (auth.isLoggedIn()) {
  console.log('å·²ç™»å½•')
} else {
  console.log('æœªç™»å½•')
  // æ˜¾ç¤ºç™»å½•å¼¹çª—
  await auth.showLoginModal()
}
```

## ğŸ” æ¥å£è¯´æ˜

### åç«¯æ¥å£

#### 1. å¾®ä¿¡ç™»å½•
```
POST /api/auth/login
Content-Type: application/json

{
  "loginCode": "ç”¨æˆ·ç™»å½•å‡­è¯code",
  "phoneCode": "æ‰‹æœºå·æˆæƒcodeï¼ˆå¯é€‰ï¼‰"
}

å“åº”ï¼š
{
  "code": 200,
  "msg": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "JWTä»¤ç‰Œ",
    "refreshToken": "åˆ·æ–°ä»¤ç‰Œ",
    "openid": "ç”¨æˆ·å”¯ä¸€æ ‡è¯†",
    "phone": "æ‰‹æœºå·ï¼ˆå¦‚æœæœ‰ï¼‰",
    "expiresIn": 604800
  }
}
```

#### 2. è·å–ç”¨æˆ·ä¿¡æ¯
```
GET /api/auth/userinfo
Authorization: Bearer {token}

å“åº”ï¼š
{
  "code": 200,
  "msg": "è·å–æˆåŠŸ",
  "data": {
    "openid": "ç”¨æˆ·å”¯ä¸€æ ‡è¯†",
    "phone": "æ‰‹æœºå·",
    "createTime": "åˆ›å»ºæ—¶é—´",
    "lastLoginTime": "æœ€åç™»å½•æ—¶é—´"
  }
}
```

#### 3. åˆ·æ–°ä»¤ç‰Œ
```
POST /api/auth/refresh
Content-Type: application/json

{
  "refreshToken": "åˆ·æ–°ä»¤ç‰Œ"
}

å“åº”ï¼š
{
  "code": 200,
  "msg": "åˆ·æ–°æˆåŠŸ",
  "data": {
    "token": "æ–°çš„JWTä»¤ç‰Œ",
    "refreshToken": "æ–°çš„åˆ·æ–°ä»¤ç‰Œ",
    "expiresIn": 604800
  }
}
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. ç™»å½•å¤±è´¥ï¼šè·å– session_key å¤±è´¥

**åŸå› **ï¼šAppID æˆ– AppSecret é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `config/env.example` ä¸­çš„é…ç½®æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ AppSecret æ˜¯å¦å·²è¿‡æœŸæˆ–è¢«é‡ç½®
3. æ£€æŸ¥å¾®ä¿¡å…¬ä¼—å¹³å°çš„IPç™½åå•è®¾ç½®

### 2. çœŸæœºè°ƒè¯•æ—¶æ— æ³•è¿æ¥åç«¯

**åŸå› **ï¼šæ‰‹æœºå’Œç”µè„‘ä¸åœ¨åŒä¸€å±€åŸŸç½‘ï¼Œæˆ–IPé…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿æ‰‹æœºå’Œç”µè„‘è¿æ¥åŒä¸€WiFi
2. æŸ¥çœ‹ç”µè„‘çš„å±€åŸŸç½‘IPåœ°å€ï¼š
   - Windows: `ipconfig`
   - Mac/Linux: `ifconfig` æˆ– `ip addr`
3. åœ¨ `miniprogram/utils/api.js` ä¸­æ›´æ–° IP åœ°å€

### 3. è·å–æ‰‹æœºå·å¤±è´¥

**åŸå› **ï¼š
- å°ç¨‹åºè´¦å·ç±»å‹ä¸æ”¯æŒï¼ˆä¸ªäººè´¦å·ä¸æ”¯æŒï¼‰
- æœªé…ç½®æ­£ç¡®çš„ä¸šåŠ¡åŸŸå
- ç”¨æˆ·å–æ¶ˆæˆæƒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤å°ç¨‹åºè´¦å·ä¸ºä¼ä¸šè´¦å·
2. æ£€æŸ¥å¾®ä¿¡å…¬ä¼—å¹³å°çš„ä¸šåŠ¡åŸŸåé…ç½®
3. å¼•å¯¼ç”¨æˆ·é‡æ–°æˆæƒ

### 4. Token éªŒè¯å¤±è´¥

**åŸå› **ï¼šToken è¿‡æœŸæˆ– JWT_SECRET ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ JWT_SECRET é…ç½®æ˜¯å¦æ­£ç¡®
2. ä½¿ç”¨ refreshToken åˆ·æ–°ä»¤ç‰Œ
3. æç¤ºç”¨æˆ·é‡æ–°ç™»å½•

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡å°ç¨‹åºç™»å½•å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)
- [è·å–æ‰‹æœºå·å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)
- [code2Session æ¥å£æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html)

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å®‰å…¨æ€§**
   - ä¸è¦åœ¨å‰ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
   - Token ä½¿ç”¨ HTTPS ä¼ è¾“
   - å®šæœŸåˆ·æ–° Token

2. **ç”¨æˆ·ä½“éªŒ**
   - é™é»˜ç™»å½•ï¼Œå‡å°‘ç”¨æˆ·æ“ä½œ
   - æ‰‹æœºå·æˆæƒè®¾ä¸ºå¯é€‰
   - æä¾›è·³è¿‡ç™»å½•é€‰é¡¹

3. **é”™è¯¯å¤„ç†**
   - è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - å‹å¥½çš„é”™è¯¯æç¤º
   - è‡ªåŠ¨é‡è¯•æœºåˆ¶

## ğŸ¯ ä¸‹ä¸€æ­¥

é…ç½®å®Œæˆåï¼Œä½ å¯ä»¥ï¼š

1. å¯åŠ¨åç«¯æœåŠ¡
2. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è¿è¡Œå°ç¨‹åº
3. ç‚¹å‡»"ç²˜è´´å¹¶è§£æ"æŒ‰é’®æµ‹è¯•ç™»å½•æµç¨‹
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤ç™»å½•çŠ¶æ€

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
- åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- ç¯å¢ƒå˜é‡é…ç½®æ˜¯å¦æ­£ç¡®
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

