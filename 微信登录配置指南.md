# 微信登录配置指南

本指南将帮助你配置微信小程序的登录功能。

## 📋 前置要求

1. 已注册微信小程序账号
2. 已获取小程序的 AppID 和 AppSecret
3. 已安装项目依赖（axios, jsonwebtoken）

## 🔧 后端配置

### 1. 配置环境变量

编辑 `config/env.example` 文件（或创建 `.env` 文件）：

```bash
# 微信小程序配置
WX_APPID=your_wx_appid_here          # 替换为你的小程序 AppID
WX_APP_SECRET=your_wx_app_secret_here # 替换为你的小程序 AppSecret

# JWT配置
JWT_SECRET=your_jwt_secret_key_here   # 生成一个随机密钥
```

#### 如何获取 AppID 和 AppSecret？

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" -> "开发管理" -> "开发设置"
3. 在"开发者ID"部分找到：
   - **AppID(小程序ID)**
   - **AppSecret(小程序密钥)**

> ⚠️ **安全提示**：AppSecret 非常重要，请妥善保管，不要泄露！

#### 生成 JWT_SECRET

可以使用以下方法生成随机密钥：

```bash
# 使用 Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 或使用 OpenSSL
openssl rand -hex 32
```

### 2. 安装依赖（如果还未安装）

```bash
npm install axios jsonwebtoken
# 或
pnpm install axios jsonwebtoken
```

### 3. 启动后端服务

```bash
npm start
# 或
node app.js
```

确保后端服务启动在 `http://localhost:3000` 或你配置的端口。

## 📱 前端配置

### 1. 配置服务器域名

在小程序开发时，需要配置服务器域名：

#### 方法一：开发阶段（推荐）

在微信开发者工具中：
1. 点击右上角"详情"
2. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

#### 方法二：生产环境

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" -> "开发管理" -> "开发设置" -> "服务器域名"
3. 配置以下域名：
   - **request合法域名**：添加你的后端服务器域名
   - **socket合法域名**：如需使用 WebSocket，添加对应域名
   - **uploadFile合法域名**：如需上传文件，添加对应域名
   - **downloadFile合法域名**：如需下载文件，添加对应域名

> ⚠️ **注意**：域名必须使用 HTTPS 协议（本地开发除外）

### 2. 配置后端 API 地址

编辑 `miniprogram/utils/api.js`，确保 `baseUrl` 配置正确：

```javascript
const getConfig = () => {
  try {
    const accountInfo = wx.getAccountInfoSync()
    const systemInfo = wx.getSystemInfoSync()
    const isSimulator = systemInfo.platform === 'devtools'
    
    if (isSimulator) {
      // 开发工具环境
      return {
        baseUrl: 'http://localhost:3000/api',  // 本地开发地址
        debug: true,
        timeout: 10000
      }
    } else {
      // 真机调试环境 - 请修改为您的电脑IP地址
      return {
        baseUrl: 'http://192.168.x.x:3000/api', // 修改为你的局域网IP
        debug: true,
        timeout: 15000
      }
    }
  } catch (error) {
    console.error('获取环境配置失败:', error)
    return {
      baseUrl: 'http://localhost:3000/api',
      debug: true,
      timeout: 10000
    }
  }
}
```

> 💡 **提示**：真机调试时，需要将 `192.168.x.x` 替换为你的电脑局域网IP地址

### 3. 配置小程序权限

在 `miniprogram/app.json` 中确保已配置必要权限：

```json
{
  "permission": {
    "scope.userLocation": {
      "desc": "你的位置信息将用于小程序位置接口的效果展示"
    }
  },
  "requiredPrivateInfos": [
    "getLocation",
    "chooseAddress",
    "getPhoneNumber"
  ]
}
```

## 🚀 使用流程

### 1. 基础登录流程（不获取手机号）

```javascript
// 调用登录方法
const auth = require('../../utils/auth.js')

const result = await auth.login()
if (result.success) {
  console.log('登录成功:', result.data)
  // result.data 包含: token, openid, expiresIn
} else {
  console.error('登录失败:', result.error)
}
```

### 2. 获取手机号登录流程

在 WXML 中：

```xml
<button 
  open-type="getPhoneNumber" 
  bindgetphonenumber="onGetPhoneNumber"
>
  授权手机号
</button>
```

在 JS 中：

```javascript
async onGetPhoneNumber(e) {
  if (e.detail.code) {
    const phoneCode = e.detail.code
    const result = await auth.login(phoneCode)
    
    if (result.success) {
      console.log('登录成功，已获取手机号:', result.data.phone)
    }
  } else {
    console.log('用户取消授权')
  }
}
```

### 3. 检查登录状态

```javascript
const auth = require('../../utils/auth.js')

// 检查是否已登录
if (auth.isLoggedIn()) {
  console.log('已登录')
} else {
  console.log('未登录')
  // 显示登录弹窗
  await auth.showLoginModal()
}
```

## 🔍 接口说明

### 后端接口

#### 1. 微信登录
```
POST /api/auth/login
Content-Type: application/json

{
  "loginCode": "用户登录凭证code",
  "phoneCode": "手机号授权code（可选）"
}

响应：
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "token": "JWT令牌",
    "refreshToken": "刷新令牌",
    "openid": "用户唯一标识",
    "phone": "手机号（如果有）",
    "expiresIn": 604800
  }
}
```

#### 2. 获取用户信息
```
GET /api/auth/userinfo
Authorization: Bearer {token}

响应：
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "openid": "用户唯一标识",
    "phone": "手机号",
    "createTime": "创建时间",
    "lastLoginTime": "最后登录时间"
  }
}
```

#### 3. 刷新令牌
```
POST /api/auth/refresh
Content-Type: application/json

{
  "refreshToken": "刷新令牌"
}

响应：
{
  "code": 200,
  "msg": "刷新成功",
  "data": {
    "token": "新的JWT令牌",
    "refreshToken": "新的刷新令牌",
    "expiresIn": 604800
  }
}
```

## 🐛 常见问题

### 1. 登录失败：获取 session_key 失败

**原因**：AppID 或 AppSecret 配置错误

**解决方案**：
1. 检查 `config/env.example` 中的配置是否正确
2. 确认 AppSecret 是否已过期或被重置
3. 检查微信公众平台的IP白名单设置

### 2. 真机调试时无法连接后端

**原因**：手机和电脑不在同一局域网，或IP配置错误

**解决方案**：
1. 确保手机和电脑连接同一WiFi
2. 查看电脑的局域网IP地址：
   - Windows: `ipconfig`
   - Mac/Linux: `ifconfig` 或 `ip addr`
3. 在 `miniprogram/utils/api.js` 中更新 IP 地址

### 3. 获取手机号失败

**原因**：
- 小程序账号类型不支持（个人账号不支持）
- 未配置正确的业务域名
- 用户取消授权

**解决方案**：
1. 确认小程序账号为企业账号
2. 检查微信公众平台的业务域名配置
3. 引导用户重新授权

### 4. Token 验证失败

**原因**：Token 过期或 JWT_SECRET 不一致

**解决方案**：
1. 检查 JWT_SECRET 配置是否正确
2. 使用 refreshToken 刷新令牌
3. 提示用户重新登录

## 📚 相关文档

- [微信小程序登录官方文档](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)
- [获取手机号官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)
- [code2Session 接口文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html)

## 💡 最佳实践

1. **安全性**
   - 不要在前端存储敏感信息
   - Token 使用 HTTPS 传输
   - 定期刷新 Token

2. **用户体验**
   - 静默登录，减少用户操作
   - 手机号授权设为可选
   - 提供跳过登录选项

3. **错误处理**
   - 详细的错误日志
   - 友好的错误提示
   - 自动重试机制

## 🎯 下一步

配置完成后，你可以：

1. 启动后端服务
2. 在微信开发者工具中运行小程序
3. 点击"粘贴并解析"按钮测试登录流程
4. 查看控制台日志确认登录状态

如果遇到问题，请检查：
- 后端服务是否正常运行
- 环境变量配置是否正确
- 网络连接是否正常
- 微信开发者工具的控制台错误信息

