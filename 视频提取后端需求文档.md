# 视频提取后端系统需求文档

## 项目概述

基于Node.js开发的视频提取后端系统，支持多平台视频链接解析，包括抖音/TikTok、哔哩哔哩、小红书等主流平台。系统需要根据不同平台的API规范，对前端传递的数据进行格式化处理和验证。

## 第三方API集成方案

### 核心API服务
基于第三方视频解析API (52api.cn) 提供统一的多平台支持，简化了原有的平台特定处理逻辑。

#### 第三方API规范
- **接口地址**: `https://www.52api.cn/api/video_parse`
- **请求方式**: GET/POST
- **返回格式**: application/json
- **请求Header**: `Content-Type: application/x-www-form-urlencoded;charset=utf-8`

#### 支持平台
通过第三方API统一支持以下平台：
- 抖音/TikTok
- 哔哩哔哩（包括合集视频）
- 小红书
- 快手
- 其他主流短视频平台

### 前端数据要求（简化版）

```javascript
{
  "url": "短视频作品分享链接", // 支持各平台的分享链接
  "platform": "auto", // 自动识别或手动指定平台
  "options": {
    "preferredQuality": "high|medium|low", // 可选
    "extractAudio": false // 可选，是否提取音频
  }
}
```

### URL预处理逻辑

根据原有规范，仍需要对部分平台进行URL预处理：

```javascript
class UrlProcessor {
  static process(rawUrl, platform = 'auto') {
    // 自动检测平台类型
    if (platform === 'auto') {
      platform = this.detectPlatform(rawUrl);
    }
    
    switch (platform) {
      case 'douyin':
      case 'tiktok':
        return rawUrl.trim(); // 无需处理
        
      case 'bilibili':
      case 'xiaohongshu':
        // 提取https链接，去除前面的文本和表情
        const match = rawUrl.match(/https:\/\/[^\s\u4e00-\u9fa5]*/);
        return match ? match[0] : rawUrl.trim();
        
      default:
        return rawUrl.trim();
    }
  }
  
  static detectPlatform(url) {
    if (url.includes('douyin.com') || url.includes('tiktok.com')) return 'douyin';
    if (url.includes('bilibili.com') || url.includes('b23.tv')) return 'bilibili';
    if (url.includes('xiaohongshu.com') || url.includes('xhslink.com')) return 'xiaohongshu';
    if (url.includes('kuaishou.com')) return 'kuaishou';
    return 'unknown';
  }
}

## 技术架构要求

### 后端技术栈
- **运行环境**: Node.js (建议v16+)
- **Web框架**: Express.js 或 Koa.js
- **数据库**: MySQL 5.7
- **数据库连接**: mysql2 或 sequelize ORM
- **HTTP客户端**: axios 
- **数据验证**: joi 或 yup
- **日志记录**: winston 或 pino

### 核心模块设计

#### 1. 路由层 (Routes)
```javascript
// 视频解析接口
POST /api/video/parse

// API密钥管理接口（基础CRUD）
GET    /api/admin/keys        // 获取密钥列表
POST   /api/admin/keys        // 添加新密钥
PUT    /api/admin/keys/:keyId // 更新密钥
DELETE /api/admin/keys/:keyId // 删除密钥
```

#### 2. 控制层 (Controllers)
- 请求数据验证
- 平台识别和路由
- 错误处理和响应
- API密钥管理逻辑

#### 3. 服务层 (Services)
- 第三方API调用服务
- URL预处理服务
- 密钥管理服务（基础选择和分配）

#### 4. 工具层 (Utils)
- URL提取工具函数
- 数据格式转换
- 通用验证函数

#### 5. 数据访问层 (DAL)
- API密钥的CRUD操作
- 基础数据存储

### 数据流程

```
前端请求 
  ↓
验证请求数据
  ↓
URL预处理（提取纯链接）
  ↓
获取可用API密钥（简单轮询）
  ↓
调用第三方API
  ↓
处理API响应
  ↓
数据格式转换
  ↓
返回统一格式响应
```

## 数据库设计

### 数据库配置
- **数据库类型**: MySQL 5.7
- **数据库账号**: root
- **数据库密码**: 12345678@
- **数据库名称**: video_extract_db（建议）
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci

### 数据库连接配置示例
```javascript
const dbConfig = {
  host: 'localhost',
  port: 3306,
  user: 'root',
  password: '12345678@',
  database: 'video_extract_db',
  charset: 'utf8mb4',
  timezone: '+08:00',
  connectionLimit: 10,
  acquireTimeout: 60000,
  timeout: 60000
};
```

### API密钥表 (api_keys)
```sql
CREATE TABLE api_keys (
  id INT PRIMARY KEY AUTO_INCREMENT,
  key_name VARCHAR(100) NOT NULL COMMENT '密钥名称',
  key_value VARCHAR(255) NOT NULL COMMENT '密钥值',
  status ENUM('active', 'inactive') DEFAULT 'active' COMMENT '状态',
  description TEXT NULL COMMENT '密钥描述',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_status (status),
  UNIQUE KEY uk_key_name (key_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='API密钥管理表';
```

## 密钥管理核心逻辑

### 基础密钥选择策略
```javascript
class KeyManager {
  /**
   * 获取可用的API密钥（简单轮询）
   */
  async getAvailableKey() {
    // 获取所有活跃密钥
    const activeKeys = await this.getActiveKeys();
    
    if (activeKeys.length === 0) {
      throw new Error('没有可用的API密钥');
    }
    
    // 简单轮询策略：随机选择一个活跃密钥
    const randomIndex = Math.floor(Math.random() * activeKeys.length);
    return activeKeys[randomIndex];
  }
  
  /**
   * 调用第三方API
   */
  async callThirdPartyAPI(url) {
    const key = await this.getAvailableKey();
    
    try {
      // 构造请求参数
      const params = new URLSearchParams({
        key: key.key_value,
        url: url
      });
      
      // 调用第三方API
      const response = await axios.post('https://www.52api.cn/api/video_parse', params, {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8'
        },
        timeout: 10000
      });
      
      return response.data;
      
    } catch (error) {
      // 简单错误处理，可以根据需要扩展
      throw new Error(`API调用失败: ${error.message}`);
    }
  }
  
  /**
   * 获取活跃密钥列表
   */
  async getActiveKeys() {
    // 从MySQL数据库获取状态为active的密钥
    return await db.query('SELECT * FROM api_keys WHERE status = ?', ['active']);
  }
}

## API接口设计

### 1. 视频解析接口

```javascript
POST /api/video/parse
Content-Type: application/json

// 请求体
{
  "url": "短视频作品分享链接",
  "platform": "auto", // 可选，自动识别或手动指定
  "options": {
    "preferredQuality": "high|medium|low", // 可选
    "extractAudio": false // 可选
  }
}
```

### 2. API密钥管理接口（基础CRUD）

提供基础的密钥管理功能，支持密钥的增删改查和状态管理：

#### 2.1 获取密钥列表
```javascript
GET /api/admin/keys

// 响应
{
  "code": 200,
  "msg": "获取成功",
  "data": [
    {
      "id": 1,
      "keyName": "主密钥1",
      "keyValue": "52api_actual_key_value", // 显示完整密钥
      "status": "active|inactive",
      "description": "主要使用的密钥",
      "createdAt": "2025-01-01 09:00:00",
      "updatedAt": "2025-01-15 10:30:00"
    }
  ]
}
```

#### 2.2 添加新密钥
```javascript
POST /api/admin/keys
Content-Type: application/json

// 请求体
{
  "keyName": "备用密钥2",
  "keyValue": "52api_actual_key_value",
  "description": "备用密钥"
}

// 响应
{
  "code": 200,
  "msg": "添加成功",
  "data": {
    "id": 2,
    "keyName": "备用密钥2",
    "status": "active"
  }
}
```

#### 2.3 更新密钥
```javascript
PUT /api/admin/keys/:keyId
Content-Type: application/json

// 请求体
{
  "keyName": "更新后的密钥名称",
  "keyValue": "新的密钥值", // 可选
  "status": "active|inactive",
  "description": "更新说明"
}

// 响应
{
  "code": 200,
  "msg": "更新成功"
}
```

#### 2.4 删除密钥
```javascript
DELETE /api/admin/keys/:keyId

// 响应
{
  "code": 200,
  "msg": "删除成功"
}
```

### 统一响应格式

基于第三方API返回结构，调整为以下格式：

```javascript
// 成功响应（基于第三方API返回结构优化）
{
  "code": 200, // 状态码
  "msg": "解析成功", // 状态信息
  "data": {
    // 第三方API返回的原始数据（已解析的视频信息）
    "platform": "平台名称",
    "title": "视频标题",
    "author": "作者信息",
    "duration": "视频时长",
    "videoUrl": "视频下载链接",
    "coverImage": "封面图片",
    "description": "视频描述",
    // 根据第三方API实际返回结构调整
  },
  "debug": null, // 调试信息（生产环境为null）
  "exec_time": 0.156, // 执行耗时
  "user_ip": "客户端IP"
}

// 错误响应
{
  "code": 400|500,
  "msg": "错误描述",
  "data": null,
  "debug": "详细错误信息（开发环境）",
  "exec_time": 0.023,
  "user_ip": "客户端IP"
}
```

## 数据验证规则

### 通用验证
- platform: 必填，枚举值
- url: 必填，字符串，长度限制
- options: 可选对象

### 平台特定验证

#### 抖音/TikTok
```javascript
const douyinSchema = {
  platform: 'douyin',
  url: Joi.string().required().min(10).max(500),
  options: Joi.object().optional()
}
```

#### 哔哩哔哩
```javascript
const bilibiliSchema = {
  platform: 'bilibili',
  url: Joi.string().required().min(10).max(1000), // 允许更长，因为包含分享文本
  options: Joi.object({
    videoType: Joi.string().valid('single', 'collection').default('single')
  }).optional()
}
```

#### 小红书
```javascript
const xiaohongshuSchema = {
  platform: 'xiaohongshu',
  url: Joi.string().required().min(10).max(1000),
  options: Joi.object({
    noteType: Joi.string().valid('video', 'image').default('video')
  }).optional()
}
```

## 错误处理机制

### 错误类型定义
1. **参数验证错误** (400): 请求参数不符合要求
2. **平台不支持错误** (400): 不支持的平台类型
3. **URL格式错误** (400): 无法从输入中提取有效URL
4. **第三方API错误** (502): 目标平台API调用失败
5. **解析失败错误** (500): 视频信息解析失败
6. **网络超时错误** (504): 请求超时

### 错误处理策略
- 详细的错误日志记录
- 用户友好的错误消息
- 失败重试机制（适用场景）
- 降级处理方案

## 性能要求

### 响应时间
- 单个视频解析：< 5秒
- 合集视频解析：< 15秒

### 并发处理
- 支持并发请求：建议50-100个并发
- 请求队列管理，防止过载

### 缓存策略
- 解析结果缓存（可选）
- 缓存时间：15分钟
- 缓存键：平台+URL的hash值

## 安全要求

### 输入安全
- URL格式验证
- XSS防护
- SQL注入防护（如使用数据库）

### 访问控制
- API调用频率限制
- IP白名单（可选）
- 用户认证（可选）

### 数据安全
- 敏感信息脱敏
- 请求日志记录
- 错误信息安全处理

## 部署要求

### 环境配置
- Node.js v16+
- MySQL 5.7 数据库服务
- PM2 进程管理
- Nginx 反向代理
- SSL证书配置

### 监控告警
- 接口响应时间监控
- 错误率监控
- 系统资源监控

## 法律合规

### 免责声明
- 集成提供的免责声明模板
- 明确第三方数据风险
- 用户责任界定

### 使用限制
- 禁止商业用途的二次分发
- 遵守各平台的服务条款
- 数据使用范围限制

## 开发计划

### 第一阶段 (优先级高)
1. 搭建基础架构
2. 实现密钥管理CRUD接口
3. 实现视频解析主接口
4. 基础错误处理

### 第二阶段 (优先级中)
1. 完善URL预处理逻辑
2. 优化密钥选择策略
3. 添加日志系统
4. 基础性能优化

### 第三阶段 (优先级低)
1. 添加缓存机制
2. 完善错误处理
3. 管理界面优化
4. 文档完善

## 技术细节补充

### URL提取工具函数示例

```javascript
class UrlExtractor {
  static extractDouyin(rawUrl) {
    // 抖音无需处理，直接返回
    return rawUrl.trim();
  }
  
  static extractBilibili(rawUrl) {
    // 提取https开头的链接
    const match = rawUrl.match(/https:\/\/[^\s\u4e00-\u9fa5]*/);
    return match ? match[0] : null;
  }
  
  static extractXiaohongshu(rawUrl) {
    // 移除emoji和中文，提取链接
    const match = rawUrl.match(/https:\/\/[^\s\u4e00-\u9fa5]*/);
    return match ? match[0] : null;
  }
}
```

### 密钥管理服务示例

```javascript
class KeyService {
  /**
   * 获取所有密钥
   */
  async getAllKeys() {
    return await db.query('SELECT * FROM api_keys ORDER BY created_at DESC');
  }
  
  /**
   * 添加新密钥
   */
  async createKey(keyData) {
    const { keyName, keyValue, description } = keyData;
    const result = await db.query(
      'INSERT INTO api_keys (key_name, key_value, description) VALUES (?, ?, ?)',
      [keyName, keyValue, description]
    );
    return result.insertId;
  }
  
  /**
   * 更新密钥
   */
  async updateKey(keyId, updateData) {
    const fields = [];
    const values = [];
    
    if (updateData.keyName) {
      fields.push('key_name = ?');
      values.push(updateData.keyName);
    }
    if (updateData.keyValue) {
      fields.push('key_value = ?');
      values.push(updateData.keyValue);
    }
    if (updateData.status) {
      fields.push('status = ?');
      values.push(updateData.status);
    }
    if (updateData.description !== undefined) {
      fields.push('description = ?');
      values.push(updateData.description);
    }
    
    values.push(keyId);
    
    return await db.query(
      `UPDATE api_keys SET ${fields.join(', ')} WHERE id = ?`,
      values
    );
  }
  
  /**
   * 删除密钥
   */
  async deleteKey(keyId) {
    return await db.query('DELETE FROM api_keys WHERE id = ?', [keyId]);
  }
}
```

这份需求文档涵盖了基于您的链接请求规范的完整后端系统设计。请根据实际情况调整具体的技术选型和实现细节。 