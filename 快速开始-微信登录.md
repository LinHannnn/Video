# 快速开始 - 微信登录功能

本文档将帮助你快速启动和测试微信登录功能。

## ⚡ 快速开始（5分钟）

### 1️⃣ 配置环境变量

在项目根目录创建 `.env` 文件（或编辑 `config/env.example`）：

```bash
# 复制示例配置
cp config/env.example .env

# 编辑配置文件
# Windows: notepad .env
# Mac/Linux: vim .env 或 nano .env
```

在 `.env` 文件中填入你的配置：

```bash
# 微信小程序配置（必填）
WX_APPID=wx1234567890abcdef          # 你的小程序 AppID
WX_APP_SECRET=abcdef1234567890abcdef # 你的小程序 AppSecret

# JWT配置（必填）
JWT_SECRET=your-random-secret-key-here # 随机生成的密钥

# 其他配置保持默认即可
PORT=3000
NODE_ENV=development
```

> 📌 **如何获取微信配置？**
> 1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
> 2. 开发 -> 开发管理 -> 开发设置 -> 开发者ID
> 3. 复制 AppID 和 AppSecret

### 2️⃣ 启动后端服务

```bash
# 确保依赖已安装
pnpm install

# 启动服务
npm start

# 或使用开发模式（自动重启）
npm run dev
```

看到以下信息表示启动成功：

```
✅ 服务器启动成功! 端口: 3000
✅ 环境: development
✅ API地址: http://localhost:3000/api
✅ 健康检查: http://localhost:3000/api/video/health
```

### 3️⃣ 配置小程序

#### 3.1 配置后端地址

编辑 `miniprogram/utils/api.js`，找到 `getConfig()` 函数：

```javascript
// 开发工具环境
return {
  baseUrl: 'http://localhost:3000/api',  // 保持不变
  debug: true,
  timeout: 10000
}

// 真机调试环境 - 修改为你的电脑IP
return {
  baseUrl: 'http://192.168.1.100:3000/api', // ⚠️ 修改这里
  debug: true,
  timeout: 15000
}
```

> 💡 **如何查看电脑IP？**
> - Windows: 打开 CMD，输入 `ipconfig`，找到 IPv4 地址
> - Mac: 系统偏好设置 -> 网络，查看 IP 地址
> - Linux: 终端输入 `ip addr` 或 `ifconfig`

#### 3.2 微信开发者工具配置

1. 打开微信开发者工具
2. 导入项目，选择 `miniprogram` 目录
3. 点击右上角"详情"
4. 勾选"不校验合法域名..."（开发阶段）

### 4️⃣ 测试登录功能

1. 在微信开发者工具中运行小程序
2. 在首页输入框中输入任意链接（或留空）
3. 点击"粘贴并解析"按钮
4. 会弹出登录弹窗，选择登录方式：
   - **快速登录**：不获取手机号，仅获取 OpenID
   - **手机号登录**：获取用户手机号（需要企业小程序账号）
5. 登录成功后会自动继续解析流程

## 📋 完整的登录流程说明

### 用户视角

```
1. 用户点击"粘贴并解析"按钮
   ↓
2. 系统检查登录状态
   - 已登录 → 直接显示免责声明
   - 未登录 → 显示登录弹窗
   ↓
3. 用户选择登录方式
   - 快速登录：wx.login() → 后端验证 → 返回 token
   - 手机号登录：wx.login() + getPhoneNumber → 后端验证 → 返回 token 和手机号
   ↓
4. 保存 token 到本地存储
   ↓
5. 继续显示免责声明，完成解析流程
```

### 技术流程

```javascript
// 前端流程
1. 检查登录状态
   auth.isLoggedIn() // 检查本地是否有 token

2. 调用微信登录
   wx.login() // 获取 code

3. 发送到后端
   POST /api/auth/login
   { loginCode: code, phoneCode: phoneCode }

4. 保存 token
   wx.setStorageSync('token', token)

5. 后续请求携带 token
   headers: { 'Authorization': 'Bearer ' + token }
```

```javascript
// 后端流程
1. 接收 loginCode
   POST /api/auth/login

2. 调用微信接口
   GET https://api.weixin.qq.com/sns/jscode2session
   获取 openid 和 session_key

3. 如果有 phoneCode，获取手机号
   POST https://api.weixin.qq.com/wxa/business/getuserphonenumber

4. 生成 JWT token
   jwt.sign({ openid, phone }, JWT_SECRET)

5. 返回给前端
   { token, refreshToken, openid, phone, expiresIn }
```

## 🔧 功能特性

### ✅ 已实现的功能

1. **微信登录集成**
   - 使用 `wx.login()` 获取用户凭证
   - 调用微信后端接口 `code2Session`
   - 获取用户 OpenID 和 Session Key

2. **手机号授权**
   - 使用 `button` 组件的 `getPhoneNumber` 能力
   - 调用微信接口获取真实手机号
   - 可选功能，用户可以跳过

3. **JWT Token 管理**
   - 生成访问 Token（7天有效期）
   - 生成刷新 Token（30天有效期）
   - Token 自动存储到本地

4. **登录状态检查**
   - 每次操作前检查登录状态
   - Token 失效自动清除
   - 友好的登录引导

5. **用户管理**
   - 自动创建新用户
   - 更新用户登录时间
   - 记录用户手机号

### 🎨 UI 特性

1. **登录弹窗**
   - 精美的弹窗设计
   - 清晰的权益说明
   - 多种登录方式

2. **按钮样式**
   - 快速登录（绿色）
   - 手机号登录（橙色）
   - 暂不登录（灰色）

3. **动画效果**
   - 弹窗出现动画
   - 按钮点击反馈
   - 加载提示

## 📱 前端 API 使用

### auth.js 工具方法

```javascript
const auth = require('../../utils/auth.js')

// 1. 检查是否已登录
if (auth.isLoggedIn()) {
  console.log('已登录')
}

// 2. 执行登录（不获取手机号）
const result = await auth.login()
if (result.success) {
  console.log('登录成功:', result.data)
}

// 3. 执行登录（获取手机号）
const phoneCode = e.detail.code // 来自 button bindgetphonenumber
const result = await auth.login(phoneCode)

// 4. 显示登录弹窗
try {
  const data = await auth.showLoginModal()
  console.log('登录成功:', data)
} catch (error) {
  console.log('用户取消登录')
}

// 5. 获取 token
const token = auth.getToken()

// 6. 退出登录
auth.logout()

// 7. 获取用户信息
const userInfo = await auth.getUserInfo()
```

### 在页面中使用

```javascript
Page({
  async onLoad() {
    // 页面加载时检查登录状态
    if (auth.isLoggedIn()) {
      console.log('用户已登录')
    }
  },

  async onButtonClick() {
    // 需要登录才能操作
    if (!auth.isLoggedIn()) {
      try {
        await auth.showLoginModal()
        // 登录成功，继续操作
        this.doSomething()
      } catch (error) {
        // 用户取消登录
        wx.showToast({ title: '请先登录', icon: 'none' })
      }
      return
    }

    // 已登录，直接操作
    this.doSomething()
  },

  // 手机号授权按钮
  async onGetPhoneNumber(e) {
    if (e.detail.code) {
      const result = await auth.login(e.detail.code)
      if (result.success) {
        wx.showToast({ title: '登录成功', icon: 'success' })
      }
    }
  }
})
```

## 🐛 调试技巧

### 1. 查看登录日志

前端控制台会输出详细的登录流程：

```
🔐 开始微信登录流程...
📡 调用后端登录接口...
✅ 登录成功: { token, openid, ... }
```

### 2. 测试后端接口

使用 curl 或 Postman 测试：

```bash
# 测试健康检查
curl http://localhost:3000/api/video/health

# 测试登录接口（需要真实的 code）
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"loginCode":"真实的code"}'
```

### 3. 查看 Token 信息

在微信开发者工具控制台：

```javascript
// 查看本地 token
wx.getStorageSync('token')

// 解析 token（使用 jwt.io）
// 复制 token，在 https://jwt.io 查看内容
```

### 4. 后端日志

查看后端控制台输出：

```
✅ 微信登录成功 { openid: 'xxx', hasPhone: true }
```

## ❓ 常见问题排查

### 问题 1：点击登录没反应

**检查步骤：**
1. 查看微信开发者工具控制台是否有错误
2. 确认后端服务是否正常运行
3. 检查 `miniprogram/utils/api.js` 中的 baseUrl 配置

**解决方案：**
```bash
# 1. 确认后端运行
npm start

# 2. 测试后端连接
curl http://localhost:3000/api/video/health

# 3. 查看前端配置
# 打开 miniprogram/utils/api.js
# 确认 baseUrl 正确
```

### 问题 2：获取手机号失败

**原因：**
- 个人小程序不支持获取手机号
- 需要企业账号

**解决方案：**
使用"快速登录"而不是"手机号登录"

### 问题 3：Token 验证失败

**检查步骤：**
1. 确认 JWT_SECRET 配置正确
2. 检查 token 是否过期
3. 查看后端日志

**解决方案：**
```javascript
// 清除本地 token 重新登录
wx.removeStorageSync('token')
```

## 📚 相关文件

- **前端登录逻辑**：`miniprogram/utils/auth.js`
- **前端API调用**：`miniprogram/utils/api.js`
- **首页集成**：`miniprogram/pages/home/home.js`
- **登录弹窗UI**：`miniprogram/pages/home/home.wxml`
- **后端登录控制器**：`controllers/authController.js`
- **后端登录服务**：`services/authService.js`
- **后端路由**：`routes/authRoutes.js`

## 🎉 成功标志

当你看到以下情况，说明配置成功：

✅ 后端服务正常启动
✅ 点击"粘贴并解析"按钮显示登录弹窗
✅ 点击"快速登录"能够成功登录
✅ 控制台输出"登录成功"
✅ 本地存储中有 token
✅ 再次点击按钮不再显示登录弹窗

## 📞 需要帮助？

如果遇到问题：

1. 查看 `微信登录配置指南.md` 详细配置说明
2. 检查微信开发者工具控制台错误信息
3. 查看后端服务控制台日志
4. 参考微信官方文档

---

**祝你配置顺利！** 🚀

