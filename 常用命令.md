# 🛠️ 常用命令参考

## 🚀 服务管理

### 启动服务
```bash
cd /home/devbox/project/Video
npm start
```

### 开发模式启动（自动重启）
```bash
npm run dev
```

### 停止服务
```bash
# 方法1：杀死所有 node 进程
pkill -f "node app.js"

# 方法2：杀死所有 nodemon 进程
pkill -f nodemon

# 方法3：查找并杀死特定端口进程
netstat -tlnp | grep :3000
kill -9 <进程ID>
```

### 查看服务状态
```bash
# 检查3000端口是否被占用
netstat -tlnp | grep :3000

# 查看 node 进程
ps aux | grep node
```

## 🧪 测试命令

### 测试健康检查
```bash
curl http://localhost:3000/api/video/health | python3 -m json.tool
```

### 测试登录接口
```bash
# 测试缺少参数的情况
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{}' | python3 -m json.tool

# 测试正常登录（需要真实的 code）
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"loginCode":"your_code_here"}' | python3 -m json.tool
```

### 运行测试脚本
```bash
node scripts/test-wechat-login.js
```

## 🗄️ 数据库管理

### 创建用户表
```bash
node scripts/createUsersTable.js
```

### 连接数据库
```bash
mysql -h video-extract-db-mysql.ns-s63t2o94.svc -P 3306 -u root -p
# 密码：12345678
```

### 查看用户表
```sql
USE video_extract_db;
SHOW TABLES;
SELECT * FROM users;
```

### 清空用户表（谨慎使用）
```sql
TRUNCATE TABLE users;
```

## 📝 日志查看

### 查看所有日志
```bash
tail -f logs/combined.log
```

### 查看错误日志
```bash
tail -f logs/error.log
```

### 查看最近100行日志
```bash
tail -n 100 logs/combined.log
```

### 搜索特定日志
```bash
grep "登录" logs/combined.log
grep "error" logs/error.log
```

## 🔧 环境配置

### 检查环境变量
```bash
node -e "require('dotenv').config(); console.log('WX_APPID:', process.env.WX_APPID); console.log('WX_APPSECRET:', process.env.WX_APPSECRET ? '✅ 已配置' : '❌ 未配置'); console.log('JWT_SECRET:', process.env.JWT_SECRET !== 'your_jwt_secret_key_here' ? '✅ 已配置' : '❌ 未配置');"
```

### 生成新的 JWT_SECRET
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

## 📦 依赖管理

### 安装所有依赖
```bash
npm install
# 或使用 pnpm
pnpm install
```

### 安装新依赖
```bash
npm install <package-name>
```

### 更新依赖
```bash
npm update
```

### 查看已安装的包
```bash
npm list --depth=0
```

## 🐛 问题排查

### 端口被占用
```bash
# 查找占用3000端口的进程
netstat -tlnp | grep :3000
# 或
ss -tlnp | grep :3000

# 杀死进程
kill -9 <进程ID>
```

### 数据库连接失败
```bash
# 测试数据库连接
mysql -h video-extract-db-mysql.ns-s63t2o94.svc -P 3306 -u root -p

# 检查数据库服务状态（如果是本地）
systemctl status mysql
```

### 模块找不到
```bash
# 重新安装依赖
rm -rf node_modules
npm install
```

### 查看完整错误堆栈
```bash
NODE_ENV=development npm start
```

## 🔄 Git 操作

### 查看状态
```bash
git status
```

### 提交更改
```bash
git add .
git commit -m "添加自动记录用户信息"
git push origin main
```

### 拉取最新代码
```bash
git pull origin main
```

## 📱 小程序开发

### 打开微信开发者工具
```bash
# 确保已安装微信开发者工具
# 导入项目：选择 miniprogram 目录
```

### 小程序测试
```bash
# 在开发者工具控制台运行
wx.login({
  success: res => console.log('code:', res.code)
})
```

## 🚨 紧急情况

### 完全重启服务
```bash
# 停止所有相关进程
pkill -9 -f node
pkill -9 -f nodemon

# 重新启动
cd /home/devbox/project/Video
npm start
```

### 清理日志文件
```bash
# 备份旧日志
mv logs/combined.log logs/combined.log.bak
mv logs/error.log logs/error.log.bak

# 创建新日志文件
touch logs/combined.log
touch logs/error.log
```

### 重置数据库（谨慎）
```bash
mysql -h video-extract-db-mysql.ns-s63t2o94.svc -P 3306 -u root -p <<EOF
DROP DATABASE IF EXISTS video_extract_db;
CREATE DATABASE video_extract_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EOF

# 重新创建表
node scripts/createUsersTable.js
```

## 📊 性能监控

### 查看系统资源
```bash
# 查看内存使用
free -h

# 查看CPU使用
top -n 1

# 查看磁盘使用
df -h
```

### 查看 Node.js 进程资源
```bash
ps aux | grep node
```

## 💡 快捷脚本

### 一键重启服务
```bash
#!/bin/bash
pkill -f "node app.js"
sleep 2
cd /home/devbox/project/Video && npm start &
echo "✅ 服务已重启"
```

### 一键检查服务状态
```bash
#!/bin/bash
echo "🔍 检查服务状态..."
curl -s http://localhost:3000/api/video/health | python3 -m json.tool
```

保存为 `check-service.sh` 并添加执行权限：
```bash
chmod +x check-service.sh
./check-service.sh
```
