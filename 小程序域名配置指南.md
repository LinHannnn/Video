# 小程序域名配置指南

## 问题现象

在真机上测试时，点击"下载视频至本地"显示**网络错误**，但在开发工具中正常。

## 原因分析

微信小程序对网络请求有严格的域名限制：
- 开发工具可以关闭域名校验（开发阶段）
- **真机必须配置合法域名**，否则会报网络错误

## 解决方案

### 第一步：登录微信公众平台

1. 访问：https://mp.weixin.qq.com/
2. 使用管理员账号扫码登录
3. 进入你的小程序

### 第二步：配置服务器域名

1. 点击左侧菜单：**开发** → **开发管理** → **开发设置**
2. 找到 **服务器域名** 部分
3. 点击 **修改** 按钮

### 第三步：添加域名

需要配置以下域名（根据你的实际服务器地址）：

#### 1. request 合法域名
用于视频解析、获取公告等 API 请求
```
https://lhbxbuktfrop.sealoshzh.site
```

#### 2. downloadFile 合法域名
用于下载视频文件
```
https://lhbxbuktfrop.sealoshzh.site
```

#### 3. uploadFile 合法域名（可选）
如果有上传功能
```
https://lhbxbuktfrop.sealoshzh.site
```

### 第四步：域名要求

✅ **域名必须满足以下条件：**
1. 必须是 **HTTPS** 协议
2. 必须已经备案（国内服务器）
3. 必须有有效的 SSL 证书
4. 不能是 IP 地址
5. 不能带端口号（必须是 443）

### 第五步：保存并等待生效

1. 点击 **保存并提交** 按钮
2. 可能需要管理员扫码确认
3. **立即生效**，无需等待

## 配置截图位置

```
微信公众平台
  └─ 小程序管理后台
      └─ 开发
          └─ 开发管理
              └─ 开发设置
                  └─ 服务器域名
                      ├─ request合法域名
                      ├─ socket合法域名
                      ├─ uploadFile合法域名
                      └─ downloadFile合法域名 ⬅️ 重点配置这个
```

## 常见问题

### Q1: 配置后还是不行？

**检查清单：**
- ✅ 确认域名已保存（刷新页面查看）
- ✅ 确认使用的是 HTTPS
- ✅ 确认 SSL 证书有效
- ✅ 重新编译小程序
- ✅ 删除小程序重新扫码体验

### Q2: 提示"域名格式不正确"？

**可能原因：**
- ❌ 使用了 HTTP（必须 HTTPS）
- ❌ 带了端口号（`:3000`）
- ❌ 使用了 IP 地址
- ❌ 域名未备案

**正确格式：**
```
✅ https://yourdomain.com
❌ http://yourdomain.com        (不是HTTPS)
❌ https://yourdomain.com:3000  (带端口)
❌ https://123.45.67.89         (IP地址)
```

### Q3: 每个月只能修改5次？

是的，微信限制**每个月只能修改5次**服务器域名配置。

**建议：**
- 一次性配置完整
- 使用通配符（如果支持）
- 提前规划好域名

### Q4: 开发阶段如何测试？

**开发工具：**
1. 右上角 **详情**
2. 勾选 **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**
3. 可以使用任何域名测试

**真机调试：**
1. 点击 **预览** 或 **真机调试**
2. 勾选 **开启调试**
3. 扫码后可以在真机测试（绕过域名限制）

## 本项目配置示例

### 当前后端地址
```
https://lhbxbuktfrop.sealoshzh.site
```

### 需要配置的域名

**request合法域名：**
```
https://lhbxbuktfrop.sealoshzh.site
```

**downloadFile合法域名：**
```
https://lhbxbuktfrop.sealoshzh.site
```

### 配置后可用的功能
- ✅ 视频解析（POST /api/video/parse）
- ✅ 获取公告（GET /api/announcements）
- ✅ 用户登录（POST /api/auth/login）
- ✅ **视频下载**（GET /api/video/download）⬅️ 新增

## 代码优化说明

为了避免配置大量第三方视频平台域名（抖音、快手、B站等），我们采用了**后端代理下载**方案：

### 优化前（❌ 真机报错）
```javascript
wx.downloadFile({
  url: videoInfo.videoUrl,  // 第三方域名，未配置
  // 抖音: https://v26.douyinvod.com/...
  // 快手: https://txmov2.a.yximgs.com/...
})
```

### 优化后（✅ 正常工作）
```javascript
wx.downloadFile({
  url: 'https://lhbxbuktfrop.sealoshzh.site/api/video/download?url=...',
  // 通过自己的服务器代理下载
})
```

### 优势
1. ✅ 只需配置1个域名（自己的服务器）
2. ✅ 无需配置所有视频平台域名
3. ✅ 视频平台域名变化不影响小程序
4. ✅ 后端可以添加下载统计、限流等功能

## 验证配置是否生效

### 方法1：查看小程序后台
```
开发 → 开发管理 → 开发设置 → 服务器域名
```
应该能看到你配置的域名

### 方法2：真机测试
1. 打开微信开发工具
2. 点击 **预览**
3. 用手机扫码（不要勾选开启调试）
4. 测试下载视频功能
5. 如果成功保存到相册 = 配置正确 ✅

### 方法3：查看控制台日志
```javascript
console.log('📥 开始下载视频（通过代理）:', proxyDownloadUrl)
// 应该看到: https://lhbxbuktfrop.sealoshzh.site/api/video/download?url=...
```

## 总结

| 操作 | 是否必需 | 说明 |
|------|---------|------|
| 配置 request 域名 | ✅ 必需 | API 请求需要 |
| 配置 downloadFile 域名 | ✅ 必需 | 下载视频需要 |
| 域名必须 HTTPS | ✅ 必需 | 微信强制要求 |
| 域名必须备案 | ✅ 必需（国内） | 国内服务器必须备案 |
| SSL 证书有效 | ✅ 必需 | 不能是自签名证书 |

配置完成后，真机上就可以正常下载视频了！🎉

---

**更新时间**: 2025-10-05  
**版本**: v1.0.0

