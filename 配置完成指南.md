# ✅ 微信登录配置完成指南

## 🔑 已生成的 JWT_SECRET

您的 JWT_SECRET 已生成：
```
eb5f2e0f1c7f14fb8fec751d5ff8dbbff05ed55eaa973a5dec874826e17c252f
```

## 📝 请更新您的 .env 文件

### ⚠️ 重要：字段名称修正

请将 `.env` 文件中的：
```env
WX_APP_SECRET=e1a2edb85223deb70257809c59fc1b54
```

修改为（去掉下划线）：
```env
WX_APPSECRET=e1a2edb85223deb70257809c59fc1b54
```

### 完整的 .env 配置

```env
# 服务器配置
PORT=3000
NODE_ENV=development
HOST=0.0.0.0

# 数据库配置 (Sealos内网连接)
DB_HOST=video-extract-db-mysql.ns-s63t2o94.svc
DB_PORT=3306
DB_USER=root
DB_PASSWORD=12345678
DB_NAME=video_extract_db

# 第三方API配置
THIRD_PARTY_API_URL=https://www.52api.cn/api/video_parse

# 日志配置
LOG_LEVEL=info
LOG_FILE=logs/app.log

# 请求限制配置
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100

# 缓存配置
CACHE_TTL=900

# 微信小程序配置
WX_APPID=wx638ec29150825d0d
WX_APPSECRET=e1a2edb85223deb70257809c59fc1b54

# JWT配置（已自动生成 - 请复制下面的值）
JWT_SECRET=eb5f2e0f1c7f14fb8fec751d5ff8dbbff05ed55eaa973a5dec874826e17c252f
JWT_EXPIRES_IN=7d
```

## 🗄️ 数据库配置

### 方式1：如果数据库已运行

直接运行创建表脚本：
```bash
cd /home/devbox/project/Video
node scripts/createUsersTable.js
```

### 方式2：如果需要启动数据库

如果您使用的是 Sealos 部署，确保数据库服务正在运行。

### 方式3：手动创建表（推荐）

如果自动创建失败，可以手动执行以下 SQL：

```sql
-- 创建用户表
CREATE TABLE IF NOT EXISTS users (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
  openid VARCHAR(100) NOT NULL UNIQUE COMMENT '微信openid',
  unionid VARCHAR(100) DEFAULT NULL COMMENT '微信unionid',
  phone VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  nickname VARCHAR(100) DEFAULT NULL COMMENT '昵称',
  avatar_url VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  last_login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后登录时间',
  login_count INT DEFAULT 0 COMMENT '登录次数',
  status TINYINT DEFAULT 1 COMMENT '状态：1正常 0禁用',
  INDEX idx_openid (openid),
  INDEX idx_phone (phone),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- 创建用户登录日志表（可选）
CREATE TABLE IF NOT EXISTS user_login_logs (
  id INT AUTO_INCREMENT PRIMARY KEY COMMENT '日志ID',
  user_id INT NOT NULL COMMENT '用户ID',
  login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
  login_type ENUM('wechat', 'phone', 'guest') DEFAULT 'wechat' COMMENT '登录类型',
  ip_address VARCHAR(50) DEFAULT NULL COMMENT 'IP地址',
  device_info TEXT DEFAULT NULL COMMENT '设备信息',
  INDEX idx_user_id (user_id),
  INDEX idx_login_time (login_time),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户登录日志表';
```

## 🧪 测试配置

### 1. 测试环境配置
```bash
cd /home/devbox/project/Video
node -e "
require('dotenv').config();
console.log('✅ WX_APPID:', process.env.WX_APPID);
console.log('✅ WX_APPSECRET:', process.env.WX_APPSECRET ? '已配置' : '❌ 未配置');
console.log('✅ JWT_SECRET:', process.env.JWT_SECRET ? '已配置' : '❌ 未配置');
"
```

预期输出：
```
✅ WX_APPID: wx638ec29150825d0d
✅ WX_APPSECRET: 已配置
✅ JWT_SECRET: 已配置
```

### 2. 启动服务测试
```bash
npm start
```

### 3. 测试登录接口
```bash
# 在另一个终端运行
node scripts/test-wechat-login.js
```

## 📱 微信小程序端测试

### 1. 打开微信开发者工具

### 2. 导入项目
- 选择 `miniprogram` 目录
- AppID: `wx638ec29150825d0d`

### 3. 测试登录流程
1. 点击首页的"粘贴并解析"按钮
2. 弹出登录弹窗
3. 点击"快速登录"或"手机号登录"
4. 查看控制台日志

### 预期日志输出

**前端（小程序控制台）**：
```
🔐 用户未登录，显示登录弹窗
📱 手机号授权回调: {code: "xxx..."}
🌐 API请求: {url: "..../auth/login", method: "POST"}
✅ API响应: {code: 200, msg: "登录成功"}
```

**后端（服务器日志）**：
```
🔐 开始登录流程...
📋 loginCode: 071xxx...
📱 phoneCode: 已提供/未提供
✅ 获取 openid 成功: oXXXXXX
✅ Token 生成成功
🎉 登录流程完成
```

## ✅ 配置检查清单

完成以下检查，确保所有配置正确：

- [ ] `.env` 文件中的 `WX_APPSECRET` 字段名称正确（无下划线）
- [ ] `.env` 文件中的 `JWT_SECRET` 已更新为生成的随机字符串
- [ ] 数据库连接配置正确
- [ ] 数据库表 `users` 已创建
- [ ] 后端服务启动成功（`npm start`）
- [ ] 测试接口响应正常
- [ ] 微信小程序 AppID 配置正确
- [ ] 小程序可以正常编译运行

## 🎯 快速命令

```bash
# 1. 更新 .env 文件中的 JWT_SECRET
# 手动编辑，或使用命令（Linux/Mac）：
echo "JWT_SECRET=eb5f2e0f1c7f14fb8fec751d5ff8dbbff05ed55eaa973a5dec874826e17c252f" >> .env

# 2. 确保字段名正确
# 将 WX_APP_SECRET 改为 WX_APPSECRET（手动编辑）

# 3. 创建数据库表（如果数据库已运行）
node scripts/createUsersTable.js

# 4. 测试配置
node scripts/test-wechat-login.js

# 5. 启动服务
npm start
```

## 📚 相关文档

- 完整指南：`微信手机号登录完整指南.md`
- 快速部署：`微信登录快速部署指南.md`
- 配置示例：`config/wechat.env.example`

## 🆘 遇到问题？

### 问题1：WX_APPSECRET 读取不到
**检查**：确保 .env 文件中是 `WX_APPSECRET` 而不是 `WX_APP_SECRET`

### 问题2：JWT_SECRET 还是默认值
**检查**：确保已将上面生成的 JWT_SECRET 复制到 .env 文件

### 问题3：数据库连接失败
**解决**：
1. 检查数据库服务是否运行
2. 验证数据库配置是否正确
3. 尝试手动执行 SQL 创建表

### 问题4：登录接口报错
**排查**：
1. 查看后端日志：`logs/error.log`
2. 检查环境变量是否正确加载
3. 运行测试脚本：`node scripts/test-wechat-login.js`

## 🎉 完成！

配置完成后，您的微信登录功能就可以正常使用了！

**下一步**：
1. 在微信公众平台配置服务器域名
2. 开通手机号快速验证权限（企业小程序）
3. 进行真机测试

祝您使用顺利！
