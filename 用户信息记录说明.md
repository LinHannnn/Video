# 📊 用户信息自动记录功能说明

## ✅ 当前已实现的功能

### 1. 登录时自动记录

当用户登录时，后端会自动：

#### 新用户（首次登录）
```javascript
// 自动创建用户记录
INSERT INTO users (
  openid,           // ✅ 微信openid（唯一标识）
  phone,            // ✅ 手机号（如果授权）
  created_at,       // ✅ 注册时间
  last_login_time,  // ✅ 最后登录时间
  login_count       // ✅ 登录次数（初始为1）
) VALUES (?, ?, NOW(), NOW(), 1)
```

#### 老用户（再次登录）
```javascript
// 自动更新用户信息
UPDATE users SET 
  phone = COALESCE(?, phone),    // ✅ 更新手机号（如果提供）
  last_login_time = NOW(),       // ✅ 更新最后登录时间
  login_count = login_count + 1  // ✅ 增加登录次数
WHERE openid = ?
```

### 2. 记录的用户信息

| 字段 | 说明 | 来源 | 状态 |
|-----|------|------|------|
| **openid** | 微信用户唯一标识 | wx.login() | ✅ 已记录 |
| **phone** | 手机号 | getPhoneNumber | ✅ 已记录（可选）|
| **created_at** | 注册时间 | 系统自动 | ✅ 已记录 |
| **last_login_time** | 最后登录时间 | 系统自动 | ✅ 已记录 |
| **login_count** | 登录次数 | 系统自动 | ✅ 已记录 |
| nickname | 昵称 | getUserInfo | ⏳ 待实现 |
| avatar_url | 头像 | getUserInfo | ⏳ 待实现 |
| gender | 性别 | getUserInfo | ⏳ 待实现 |
| country | 国家 | getUserInfo | ⏳ 待实现 |
| province | 省份 | getUserInfo | ⏳ 待实现 |
| city | 城市 | getUserInfo | ⏳ 待实现 |

## 🔍 查看用户记录

### 方法1：直接查询数据库

```sql
-- 查看所有用户
SELECT * FROM users;

-- 查看最近登录的10个用户
SELECT id, openid, phone, last_login_time, login_count 
FROM users 
ORDER BY last_login_time DESC 
LIMIT 10;

-- 查看今天登录的用户
SELECT id, openid, phone, last_login_time, login_count 
FROM users 
WHERE DATE(last_login_time) = CURDATE();

-- 统计用户数量
SELECT COUNT(*) as total_users FROM users;

-- 统计活跃用户（最近7天登录）
SELECT COUNT(*) as active_users 
FROM users 
WHERE last_login_time >= DATE_SUB(NOW(), INTERVAL 7 DAY);
```

### 方法2：通过API查询（需要实现管理接口）

```javascript
// 获取用户列表
GET /api/admin/users
Response:
{
  "code": 200,
  "data": {
    "total": 100,
    "users": [
      {
        "id": 1,
        "openid": "oXXXXXX",
        "phone": "138****8000",
        "login_count": 5,
        "last_login_time": "2025-10-05 12:00:00"
      }
    ]
  }
}
```

## 📝 登录流程详解

### 用户登录 → 自动记录

```
用户点击"快速登录"
    ↓
前端调用 wx.login()
    ↓
获取 loginCode
    ↓
发送到后端 POST /api/auth/login
    ↓
后端用 loginCode 换取 openid
    ↓
查询数据库：SELECT * FROM users WHERE openid = ?
    ↓
┌─────────────────┐
│ 用户是否存在？   │
└────┬───────┬────┘
     │       │
  【否】    【是】
     │       │
     ↓       ↓
  创建用户  更新信息
  INSERT   UPDATE
     │       │
     └───┬───┘
         ↓
    生成 JWT token
         ↓
    返回用户信息
         ↓
    ✅ 自动记录完成
```

## 🎯 实际使用示例

### 示例1：首次登录用户

**场景**：新用户第一次使用小程序

```javascript
// 前端发送
POST /api/auth/login
{
  "loginCode": "071xxx...",
  "phoneCode": null
}

// 后端处理
console.log('🔐 开始登录流程...')
console.log('✅ 获取 openid 成功: oABC123...')
console.log('✅ 创建新用户: 1')  // ← 自动创建用户记录
console.log('✅ Token 生成成功')

// 数据库记录
users 表新增一条记录:
id: 1
openid: oABC123...
phone: NULL
created_at: 2025-10-05 12:00:00
last_login_time: 2025-10-05 12:00:00
login_count: 1
```

### 示例2：再次登录用户

**场景**：用户第二次使用小程序

```javascript
// 前端发送
POST /api/auth/login
{
  "loginCode": "071yyy...",
  "phoneCode": null
}

// 后端处理
console.log('✅ 获取 openid 成功: oABC123...')
console.log('✅ 用户已存在，更新登录信息')  // ← 自动更新记录

// 数据库更新
users 表更新:
id: 1
openid: oABC123...
last_login_time: 2025-10-05 14:30:00  // ← 更新为当前时间
login_count: 2  // ← 从1增加到2
```

### 示例3：授权手机号登录

**场景**：企业小程序用户授权手机号

```javascript
// 前端发送
POST /api/auth/login
{
  "loginCode": "071zzz...",
  "phoneCode": "abc123..."
}

// 后端处理
console.log('✅ 获取 openid 成功: oABC123...')
console.log('✅ 手机号获取成功: 13800138000')  // ← 获取手机号
console.log('✅ 用户已存在，更新登录信息')

// 数据库更新
users 表更新:
id: 1
openid: oABC123...
phone: 13800138000  // ← 新增手机号
last_login_time: 2025-10-05 15:00:00
login_count: 3
```

## 📊 统计查询示例

### 用户统计

```sql
-- 1. 总用户数
SELECT COUNT(*) as total FROM users;

-- 2. 今日新增用户
SELECT COUNT(*) as new_today 
FROM users 
WHERE DATE(created_at) = CURDATE();

-- 3. 本月新增用户
SELECT COUNT(*) as new_this_month 
FROM users 
WHERE YEAR(created_at) = YEAR(NOW()) 
AND MONTH(created_at) = MONTH(NOW());

-- 4. 活跃用户（最近7天登录）
SELECT COUNT(*) as active_users 
FROM users 
WHERE last_login_time >= DATE_SUB(NOW(), INTERVAL 7 DAY);

-- 5. 留存率统计
SELECT 
  DATE(created_at) as date,
  COUNT(*) as new_users,
  SUM(CASE WHEN login_count > 1 THEN 1 ELSE 0 END) as retained_users,
  ROUND(SUM(CASE WHEN login_count > 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as retention_rate
FROM users
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 6. 用户登录频率分布
SELECT 
  CASE 
    WHEN login_count = 1 THEN '1次'
    WHEN login_count BETWEEN 2 AND 5 THEN '2-5次'
    WHEN login_count BETWEEN 6 AND 10 THEN '6-10次'
    WHEN login_count BETWEEN 11 AND 20 THEN '11-20次'
    ELSE '20次以上'
  END as login_frequency,
  COUNT(*) as user_count
FROM users
GROUP BY 
  CASE 
    WHEN login_count = 1 THEN '1次'
    WHEN login_count BETWEEN 2 AND 5 THEN '2-5次'
    WHEN login_count BETWEEN 6 AND 10 THEN '6-10次'
    WHEN login_count BETWEEN 11 AND 20 THEN '11-20次'
    ELSE '20次以上'
  END
ORDER BY 
  MIN(login_count);
```

## 🔒 隐私保护

### 数据处理原则

1. **最小化原则**
   - 只收集必要的信息（openid、phone）
   - 不收集敏感个人信息

2. **匿名化处理**
   - openid 已经是加密的
   - 手机号显示时需要脱敏

3. **数据安全**
   - 使用 HTTPS 传输
   - 数据库加密存储
   - 定期备份

### 隐私合规

```javascript
// 手机号脱敏显示
function maskPhone(phone) {
  if (!phone) return null
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
}

// 使用示例
const phone = '13800138000'
const masked = maskPhone(phone)  // 138****8000
```

## 🎯 最佳实践

### 1. 记录完整日志

```javascript
// 建议在登录时记录完整日志
console.log('🔐 用户登录:', {
  openid: user.openid,
  phone: user.phone ? maskPhone(user.phone) : null,
  isNewUser: !rows.length,
  loginCount: user.login_count,
  lastLoginTime: user.last_login_time
})
```

### 2. 定期清理数据

```sql
-- 清理6个月未登录的用户（根据业务需求调整）
DELETE FROM users 
WHERE last_login_time < DATE_SUB(NOW(), INTERVAL 6 MONTH)
AND login_count = 1;  -- 只登录过一次的用户
```

### 3. 数据导出

```sql
-- 导出用户数据（用于分析）
SELECT 
  id,
  LEFT(openid, 10) as openid_prefix,  -- 只导出部分openid
  CASE WHEN phone IS NOT NULL THEN '已绑定' ELSE '未绑定' END as phone_status,
  DATE(created_at) as register_date,
  DATE(last_login_time) as last_login_date,
  login_count
FROM users
INTO OUTFILE '/tmp/users_export.csv'
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n';
```

## ✅ 功能验证

### 验证步骤

1. **登录并查看记录**
   ```bash
   # 小程序端登录后，查询数据库
   mysql> SELECT * FROM users ORDER BY id DESC LIMIT 1;
   ```

2. **验证登录次数**
   ```bash
   # 多次登录，检查 login_count 是否增加
   mysql> SELECT id, openid, login_count FROM users WHERE id = 1;
   ```

3. **验证时间更新**
   ```bash
   # 检查最后登录时间是否更新
   mysql> SELECT id, last_login_time FROM users WHERE id = 1;
   ```

## 📋 总结

### ✅ 已实现功能
- ✅ 自动创建用户记录
- ✅ 记录 openid
- ✅ 记录手机号（可选）
- ✅ 记录注册时间
- ✅ 更新最后登录时间
- ✅ 统计登录次数

### 🎯 核心优势
1. **完全自动化**：无需手动操作，登录即记录
2. **数据完整**：记录关键用户信息
3. **实时更新**：每次登录自动更新
4. **高效查询**：支持各种统计分析

### 💡 使用建议
1. 定期查看用户数据，了解用户活跃度
2. 基于登录次数设计会员等级
3. 分析用户留存率，优化产品
4. 保护用户隐私，遵守数据安全法规

---

**结论**：用户信息自动记录功能已完整实现，每次用户登录都会自动记录或更新用户信息！✅
