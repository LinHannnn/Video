# ğŸ“± å¾®ä¿¡æ‰‹æœºå·ä¸€é”®ç™»å½•å®Œæ•´æŒ‡å—

## âœ… å½“å‰å®ç°çŠ¶æ€

æ‚¨çš„å°ç¨‹åº**å·²ç»å®Œæ•´å®ç°äº†å¾®ä¿¡æ‰‹æœºå·ç™»å½•åŠŸèƒ½**ï¼åŒ…æ‹¬ï¼š

### å‰ç«¯å·²å®ç°çš„åŠŸèƒ½
- âœ… ç™»å½•å¼¹çª—UIï¼ˆå¿«é€Ÿç™»å½• + æ‰‹æœºå·ç™»å½•ï¼‰
- âœ… æ‰‹æœºå·æˆæƒæŒ‰é’®ï¼ˆä½¿ç”¨ open-type="getPhoneNumber"ï¼‰
- âœ… æˆæƒå›è°ƒå¤„ç†å‡½æ•°
- âœ… ä¸åç«¯APIå¯¹æ¥çš„ä»£ç 
- âœ… Tokenå­˜å‚¨å’ŒçŠ¶æ€ç®¡ç†

## ğŸ“‹ å®ç°åŸç†

### 1. å‰ç«¯æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"æ‰‹æœºå·ç™»å½•"æŒ‰é’®
    â†“
è§¦å‘å¾®ä¿¡æˆæƒå¼¹çª—
    â†“
ç”¨æˆ·åŒæ„æˆæƒ
    â†“
è·å– phoneCode (åŠ å¯†çš„æ‰‹æœºå·ä¿¡æ¯)
    â†“
åŒæ—¶è·å– loginCode (wx.login)
    â†“
å‘é€ä¸¤ä¸ª code åˆ°åç«¯
    â†“
åç«¯è§£å¯†è·å–çœŸå®æ‰‹æœºå·
    â†“
è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯
    â†“
å‰ç«¯ä¿å­˜ tokenï¼Œå®Œæˆç™»å½•
```

### 2. å…³é”®ä»£ç ä½ç½®

#### ç™»å½•æŒ‰é’® (pages/home/home.wxml:68-74)
```xml
<button 
  class="modal-btn phone-login-btn" 
  open-type="getPhoneNumber" 
  bindgetphonenumber="onGetPhoneNumber"
>
  æ‰‹æœºå·ç™»å½•
</button>
```

#### æˆæƒå›è°ƒå¤„ç† (pages/home/home.js:171-208)
```javascript
async onGetPhoneNumber(e) {
  console.log('ğŸ“± æ‰‹æœºå·æˆæƒå›è°ƒ:', e.detail)
  
  if (e.detail.code) {
    try {
      util.showLoading('æ­£åœ¨è·å–æ‰‹æœºå·...')
      
      // ä½¿ç”¨æ‰‹æœºå· code è¿›è¡Œç™»å½•
      const phoneCode = e.detail.code
      const result = await auth.login(phoneCode)
      
      if (result.success) {
        util.showToast('ç™»å½•æˆåŠŸ', 'success')
        // ... å…³é—­å¼¹çª—ï¼Œç»§ç»­ä¸šåŠ¡æµç¨‹
      }
    } catch (error) {
      util.showToast(error.message || 'è·å–æ‰‹æœºå·å¤±è´¥')
    }
  }
}
```

#### ç™»å½•å‡½æ•° (utils/auth.js:59-96)
```javascript
const login = async (phoneCode = null) => {
  // 1. è·å–å¾®ä¿¡ç™»å½• code
  const loginCode = await getWxLoginCode()
  
  // 2. è°ƒç”¨åç«¯ç™»å½•æ¥å£
  const result = await api.wxLogin(loginCode, phoneCode)
  
  // 3. ä¿å­˜ token å’Œç”¨æˆ·ä¿¡æ¯
  if (result.code === 200 && result.data) {
    setToken(result.data.token)
    app.globalData.userInfo = result.data
    return { success: true, data: result.data }
  }
}
```

#### APIè°ƒç”¨ (utils/api.js:201-211)
```javascript
const wxLogin = async (loginCode, phoneCode = null) => {
  return await request('/auth/login', {
    method: 'POST',
    data: { loginCode, phoneCode }
  })
}
```

## ğŸ”§ åç«¯éœ€è¦å®ç°çš„æ¥å£

### APIæ¥å£è§„èŒƒ

**æ¥å£åœ°å€**: `POST /auth/login`

**è¯·æ±‚å‚æ•°**:
```json
{
  "loginCode": "å¾®ä¿¡ç™»å½•codeï¼ˆwx.loginè·å–ï¼‰",
  "phoneCode": "æ‰‹æœºå·æˆæƒcodeï¼ˆå¯é€‰ï¼Œç”¨æˆ·æˆæƒåæ‰æœ‰ï¼‰"
}
```

**åç«¯å¤„ç†æµç¨‹**:
```javascript
// ä¼ªä»£ç ç¤ºä¾‹
async function login(req, res) {
  const { loginCode, phoneCode } = req.body
  
  // 1. ä½¿ç”¨ loginCode æ¢å– openid å’Œ session_key
  const wxResult = await wx.code2Session({
    appid: 'your_appid',
    secret: 'your_secret',
    js_code: loginCode
  })
  
  const { openid, session_key } = wxResult
  
  // 2. å¦‚æœæœ‰ phoneCodeï¼Œè§£å¯†è·å–æ‰‹æœºå·
  let phoneNumber = null
  if (phoneCode) {
    phoneNumber = await wx.getPhoneNumber({
      code: phoneCode
    })
  }
  
  // 3. åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  const user = await User.findOrCreate({
    openid: openid,
    phone: phoneNumber
  })
  
  // 4. ç”Ÿæˆ token
  const token = jwt.sign({ userId: user.id }, 'secret')
  
  // 5. è¿”å›ç»“æœ
  res.json({
    code: 200,
    msg: 'ç™»å½•æˆåŠŸ',
    data: {
      token: token,
      openid: openid,
      phone: phoneNumber,
      userId: user.id
    }
  })
}
```

### Node.js åç«¯å®ç°ç¤ºä¾‹

```javascript
// controllers/authController.js
const axios = require('axios')
const jwt = require('jsonwebtoken')

// å¾®ä¿¡å°ç¨‹åºé…ç½®
const WX_CONFIG = {
  appId: process.env.WX_APPID,
  appSecret: process.env.WX_APPSECRET
}

// ç™»å½•æ¥å£
exports.login = async (req, res) => {
  try {
    const { loginCode, phoneCode } = req.body
    
    if (!loginCode) {
      return res.status(400).json({
        code: 400,
        msg: 'ç¼ºå°‘ç™»å½•å‡­è¯'
      })
    }
    
    // 1. è°ƒç”¨å¾®ä¿¡æ¥å£è·å– openid
    const wxLoginUrl = `https://api.weixin.qq.com/sns/jscode2session?appid=${WX_CONFIG.appId}&secret=${WX_CONFIG.appSecret}&js_code=${loginCode}&grant_type=authorization_code`
    
    const wxResponse = await axios.get(wxLoginUrl)
    const { openid, session_key, errcode, errmsg } = wxResponse.data
    
    if (errcode) {
      throw new Error(`å¾®ä¿¡ç™»å½•å¤±è´¥: ${errmsg}`)
    }
    
    // 2. å¦‚æœæœ‰ phoneCodeï¼Œè·å–æ‰‹æœºå·
    let phoneNumber = null
    if (phoneCode) {
      const phoneUrl = `https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=${await getAccessToken()}`
      
      const phoneResponse = await axios.post(phoneUrl, {
        code: phoneCode
      })
      
      if (phoneResponse.data.errcode === 0) {
        phoneNumber = phoneResponse.data.phone_info.phoneNumber
      }
    }
    
    // 3. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    let user = await User.findOne({ where: { openid } })
    if (!user) {
      user = await User.create({
        openid,
        phone: phoneNumber,
        loginTime: new Date()
      })
    } else {
      // æ›´æ–°æ‰‹æœºå·å’Œç™»å½•æ—¶é—´
      await user.update({
        phone: phoneNumber || user.phone,
        loginTime: new Date()
      })
    }
    
    // 4. ç”Ÿæˆ JWT token
    const token = jwt.sign(
      { 
        userId: user.id, 
        openid: user.openid 
      },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    )
    
    // 5. è¿”å›ç»“æœ
    res.json({
      code: 200,
      msg: 'ç™»å½•æˆåŠŸ',
      data: {
        token,
        openid: user.openid,
        phone: user.phone,
        userId: user.id
      }
    })
    
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error)
    res.status(500).json({
      code: 500,
      msg: error.message || 'ç™»å½•å¤±è´¥'
    })
  }
}

// è·å– access_token
let accessToken = null
let tokenExpireTime = 0

async function getAccessToken() {
  // å¦‚æœ token è¿˜æœ‰æ•ˆï¼Œç›´æ¥è¿”å›
  if (accessToken && Date.now() < tokenExpireTime) {
    return accessToken
  }
  
  // è·å–æ–°çš„ access_token
  const url = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${WX_CONFIG.appId}&secret=${WX_CONFIG.appSecret}`
  
  const response = await axios.get(url)
  
  if (response.data.access_token) {
    accessToken = response.data.access_token
    // æå‰5åˆ†é’Ÿè¿‡æœŸ
    tokenExpireTime = Date.now() + (response.data.expires_in - 300) * 1000
    return accessToken
  }
  
  throw new Error('è·å–access_tokenå¤±è´¥')
}
```

## ğŸ¯ å¾®ä¿¡å°ç¨‹åºåå°é…ç½®

### 1. å¼€é€šæ‰‹æœºå·å¿«é€ŸéªŒè¯æƒé™

ç™»å½•[å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/) â†’ å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ æ¥å£è®¾ç½® â†’ "æ‰‹æœºå·å¿«é€ŸéªŒè¯ç»„ä»¶"

**æ³¨æ„**ï¼š
- ä¸ªäººå°ç¨‹åºï¼šâŒ ä¸æ”¯æŒ
- ä¼ä¸šå°ç¨‹åºï¼šâœ… éœ€è¦å…ˆè®¤è¯ï¼Œç„¶åå¼€é€š
- éœ€è¦å°ç¨‹åºå·²å‘å¸ƒè‡³å°‘ä¸€ä¸ªç‰ˆæœ¬

### 2. é…ç½®æœåŠ¡å™¨åŸŸå

å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½® â†’ æœåŠ¡å™¨åŸŸå

æ·»åŠ æ‚¨çš„åç«¯APIåŸŸåï¼Œä¾‹å¦‚ï¼š
- `https://lhbxbuktfrop.sealoshzh.site`

### 3. é…ç½®ä¸šåŠ¡åŸŸåï¼ˆå¦‚éœ€ä¸‹è½½åŠŸèƒ½ï¼‰

å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½® â†’ ä¸šåŠ¡åŸŸå

### 4. è·å– AppID å’Œ AppSecret

å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½®
- AppID: å·²åœ¨æ‚¨çš„é¡¹ç›®ä¸­é…ç½® `wx638ec29150825d0d`
- AppSecret: éœ€è¦å¦¥å–„ä¿ç®¡ï¼Œé…ç½®åœ¨åç«¯ç¯å¢ƒå˜é‡ä¸­

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æœ¬åœ°æµ‹è¯•ï¼ˆå¼€å‘å·¥å…·ï¼‰

```bash
# 1. ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œ
cd /home/devbox/project/Video
npm start

# 2. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
# 3. ç‚¹å‡»"ç²˜è´´å¹¶è§£æ"æŒ‰é’®
# 4. åº”è¯¥å¼¹å‡ºç™»å½•å¼¹çª—
# 5. ç‚¹å‡»"æ‰‹æœºå·ç™»å½•"æŒ‰é’®
```

**æ³¨æ„**ï¼šå¼€å‘å·¥å…·ä¸­è·å–æ‰‹æœºå·å¯èƒ½è¿”å›æ¨¡æ‹Ÿæ•°æ®

### 2. çœŸæœºæµ‹è¯•

```bash
# 1. ç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€ç½‘ç»œ
# 2. åç«¯æœåŠ¡ä½¿ç”¨å…¬ç½‘åœ°å€æˆ–å±€åŸŸç½‘IP
# 3. åœ¨å¼€å‘å·¥å…·ä¸­ç‚¹å‡»"çœŸæœºè°ƒè¯•"
# 4. æ‰«ç åœ¨æ‰‹æœºä¸Šæµ‹è¯•
```

### 3. ä½“éªŒç‰ˆæµ‹è¯•

```bash
# 1. ä¸Šä¼ ä½“éªŒç‰ˆåˆ°å¾®ä¿¡æœåŠ¡å™¨
# 2. åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æ·»åŠ ä½“éªŒæˆå‘˜
# 3. æ‰«ç ä½“éªŒç‰ˆäºŒç»´ç æµ‹è¯•
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. ç‚¹å‡»æŒ‰é’®æ²¡æœ‰å¼¹å‡ºæˆæƒå¼¹çª—

**åŸå› **ï¼š
- æ²¡æœ‰é…ç½®æ­£ç¡®çš„ AppID
- å°ç¨‹åºæœªå¼€é€šæ‰‹æœºå·æƒé™
- button çš„ open-type å±æ€§è®¾ç½®é”™è¯¯

**è§£å†³**ï¼š
```xml
<!-- ç¡®ä¿ button æœ‰è¿™äº›å±æ€§ -->
<button 
  open-type="getPhoneNumber" 
  bindgetphonenumber="onGetPhoneNumber"
>
  è·å–æ‰‹æœºå·
</button>
```

### 2. e.detail.code ä¸ºç©º

**åŸå› **ï¼šç”¨æˆ·æ‹’ç»æˆæƒæˆ–æƒé™æœªå¼€é€š

**è§£å†³**ï¼š
```javascript
if (e.detail.code) {
  // ç”¨æˆ·åŒæ„æˆæƒ
} else {
  // ç”¨æˆ·æ‹’ç»æˆæƒ
  console.log('ç”¨æˆ·æ‹’ç»:', e.detail.errMsg)
}
```

### 3. åç«¯è§£å¯†å¤±è´¥

**åŸå› **ï¼š
- phoneCode å·²è¿‡æœŸï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
- access_token è¿‡æœŸ
- AppSecret é…ç½®é”™è¯¯

**è§£å†³**ï¼š
- ç¡®ä¿åŠæ—¶å¤„ç† phoneCode
- å®ç° access_token ç¼“å­˜æœºåˆ¶
- æ£€æŸ¥é…ç½®ä¿¡æ¯

### 4. è¿”å›çš„æ‰‹æœºå·æ ¼å¼

```javascript
// å¾®ä¿¡è¿”å›çš„æ‰‹æœºå·ä¿¡æ¯
{
  "errcode": 0,
  "errmsg": "ok",
  "phone_info": {
    "phoneNumber": "13800138000",      // ç”¨æˆ·æ‰‹æœºå·
    "purePhoneNumber": "13800138000",  // ä¸å¸¦åŒºå·çš„æ‰‹æœºå·
    "countryCode": "86",               // åŒºå·
    "watermark": {
      "timestamp": 1234567890,
      "appid": "wx1234567890"
    }
  }
}
```

## ğŸ“± ç”¨æˆ·ä½“éªŒä¼˜åŒ–å»ºè®®

### 1. æä¾›ä¸¤ç§ç™»å½•æ–¹å¼

æ‚¨çš„å®ç°å·²ç»åŒ…å«äº†ï¼š
- âœ… **å¿«é€Ÿç™»å½•**ï¼šä»…è·å– openidï¼Œä¸éœ€è¦æ‰‹æœºå·
- âœ… **æ‰‹æœºå·ç™»å½•**ï¼šè·å–æ‰‹æœºå·ï¼Œæ›´å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯

### 2. ç™»å½•æµç¨‹æç¤º

```javascript
// åœ¨ home.js ä¸­å·²å®ç°
util.showLoading('æ­£åœ¨è·å–æ‰‹æœºå·...')
// ... ç™»å½•é€»è¾‘
util.showToast('ç™»å½•æˆåŠŸ', 'success')
```

### 3. é”™è¯¯å¤„ç†

```javascript
try {
  // ç™»å½•é€»è¾‘
} catch (error) {
  if (error.message.includes('ç”¨æˆ·æ‹’ç»')) {
    util.showToast('éœ€è¦æˆæƒæ‰èƒ½ç»§ç»­ä½¿ç”¨')
  } else {
    util.showToast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}
```

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. Token å®‰å…¨
- âœ… ä½¿ç”¨ JWT å¹¶è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- âœ… å­˜å‚¨åœ¨å°ç¨‹åºçš„ storage ä¸­
- âœ… æ¯æ¬¡è¯·æ±‚æºå¸¦ token

### 2. æ•°æ®ä¼ è¾“å®‰å…¨
- âœ… ä½¿ç”¨ HTTPS åè®®
- âœ… ä¸åœ¨å‰ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- âœ… phoneCode ä¸€æ¬¡æ€§ä½¿ç”¨

### 3. éšç§ä¿æŠ¤
- âœ… æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·è·å–æ‰‹æœºå·çš„ç”¨é€”
- âœ… æä¾›å¿«é€Ÿç™»å½•é€‰é¡¹ï¼ˆä¸è·å–æ‰‹æœºå·ï¼‰
- âœ… éµå®ˆå¾®ä¿¡å¹³å°è§„èŒƒ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡å°ç¨‹åºæ‰‹æœºå·å¿«é€ŸéªŒè¯ç»„ä»¶](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)
- [wx.login API](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)
- [code2Session åç«¯æ¥å£](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html)
- [è·å–æ‰‹æœºå·åç«¯æ¥å£](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/phone-number/getPhoneNumber.html)

## âœ… æ£€æŸ¥æ¸…å•

ä½¿ç”¨æ­¤æ¸…å•ç¡®ä¿åŠŸèƒ½æ­£å¸¸ï¼š

- [ ] å°ç¨‹åºå·²è·å¾—ä¼ä¸šè®¤è¯
- [ ] å¼€é€šäº†"æ‰‹æœºå·å¿«é€ŸéªŒè¯"æƒé™
- [ ] é…ç½®äº†æ­£ç¡®çš„æœåŠ¡å™¨åŸŸå
- [ ] åç«¯å®ç°äº† `/auth/login` æ¥å£
- [ ] æ­£ç¡®é…ç½®äº† AppID å’Œ AppSecret
- [ ] å‰ç«¯æŒ‰é’®ä½¿ç”¨äº† `open-type="getPhoneNumber"`
- [ ] å®ç°äº†æˆæƒå›è°ƒå‡½æ•° `bindgetphonenumber`
- [ ] Token å­˜å‚¨å’ŒçŠ¶æ€ç®¡ç†æ­£å¸¸
- [ ] è¿›è¡Œäº†çœŸæœºæµ‹è¯•

## ğŸ‰ æ€»ç»“

æ‚¨çš„å°ç¨‹åºå·²ç»å®Œæ•´å®ç°äº†å¾®ä¿¡æ‰‹æœºå·ç™»å½•åŠŸèƒ½ï¼ä¸»è¦å·¥ä½œé›†ä¸­åœ¨ï¼š

1. âœ… **å‰ç«¯å·²å®Œæˆ**ï¼šUIã€æˆæƒæµç¨‹ã€çŠ¶æ€ç®¡ç†
2. ğŸ”§ **åç«¯éœ€è¦å®ç°**ï¼šç™»å½•æ¥å£ã€æ‰‹æœºå·è§£å¯†
3. âš™ï¸ **å¹³å°éœ€è¦é…ç½®**ï¼šå¼€é€šæƒé™ã€é…ç½®åŸŸå

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒæ­¤æ–‡æ¡£è¿›è¡Œæ’æŸ¥ï¼
