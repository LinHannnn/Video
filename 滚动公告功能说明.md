# 📢 滚动公告功能说明文档

## 功能概述

小程序首页新增了滚动公告功能，可以动态显示系统公告或运营消息。公告内容完全可通过后端接口自定义，支持无限长度内容。

---

## ✨ 功能特点

1. **动态加载** - 公告内容从后端接口实时获取
2. **无限制内容** - 支持任意长度的公告文本
3. **自动滚动** - 多条公告自动垂直滚动切换
4. **优先级排序** - 支持设置公告优先级
5. **时间控制** - 可设置公告的开始和结束时间
6. **状态管理** - 支持启用/禁用公告
7. **美观界面** - 渐变色背景，现代化UI设计

---

## 🎨 界面展示

```
┌──────────────────────────────────────┐
│  📢 欢迎使用视频解析小程序！         │  ← 公告图标 + 滚动内容
│      支持抖音、快手、B站等...        │
└──────────────────────────────────────┘
```

**设计特点**：
- 渐变紫色背景（`#667eea → #764ba2`）
- 白色文字，清晰易读
- 圆角设计，现代美观
- 自动垂直滚动

---

## 📊 数据库表结构

### announcements 表

| 字段名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| id | INT | 公告ID（主键） | 自增 |
| content | TEXT | 公告内容 | 必填 |
| status | TINYINT | 状态：1启用 0禁用 | 1 |
| priority | INT | 优先级（数字越大优先级越高） | 0 |
| start_time | TIMESTAMP | 开始时间 | NULL |
| end_time | TIMESTAMP | 结束时间 | NULL |
| created_at | TIMESTAMP | 创建时间 | 当前时间 |
| updated_at | TIMESTAMP | 更新时间 | 当前时间 |
| created_by | VARCHAR(100) | 创建人 | NULL |

---

## 🔌 API接口

### 1. 获取有效公告（小程序端）

**接口地址**：`GET /api/announcements/active`

**说明**：获取当前有效的公告列表（自动过滤状态、时间）

**请求示例**：
```bash
GET https://your-domain.com/api/announcements/active
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": [
    {
      "id": 1,
      "content": "🎉 欢迎使用视频解析小程序！支持抖音、快手、B站等多平台视频解析",
      "priority": 10,
      "start_time": null,
      "end_time": null
    },
    {
      "id": 2,
      "content": "📢 登录后即可使用全部功能，快来体验吧！",
      "priority": 5,
      "start_time": null,
      "end_time": null
    }
  ]
}
```

### 2. 获取所有公告（管理端）

**接口地址**：`GET /api/announcements`

**请求参数**：
- `page`（可选）：页码，默认1
- `limit`（可选）：每页数量，默认10
- `status`（可选）：状态筛选，0或1

**请求示例**：
```bash
GET https://your-domain.com/api/announcements?page=1&limit=10&status=1
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "list": [...],
    "total": 10,
    "page": 1,
    "limit": 10
  }
}
```

### 3. 创建公告

**接口地址**：`POST /api/announcements`

**请求体**：
```json
{
  "content": "🎉 双十一活动开始啦！全场视频解析免费使用！",
  "status": 1,
  "priority": 100,
  "start_time": "2025-10-10 00:00:00",
  "end_time": "2025-10-12 23:59:59",
  "created_by": "admin"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "创建成功",
  "data": {
    "id": 3
  }
}
```

### 4. 更新公告

**接口地址**：`PUT /api/announcements/:id`

**请求体**：
```json
{
  "content": "更新后的公告内容",
  "status": 1,
  "priority": 50
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "更新成功"
}
```

### 5. 删除公告

**接口地址**：`DELETE /api/announcements/:id`

**响应示例**：
```json
{
  "code": 200,
  "msg": "删除成功"
}
```

### 6. 批量更新状态

**接口地址**：`POST /api/announcements/batch/status`

**请求体**：
```json
{
  "ids": [1, 2, 3],
  "status": 0
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "更新成功",
  "data": {
    "affectedRows": 3
  }
}
```

---

## 💻 使用示例

### 示例1：创建一条简单公告

```bash
curl -X POST http://localhost:3000/api/announcements \
  -H "Content-Type: application/json" \
  -d '{
    "content": "欢迎使用本服务！",
    "status": 1,
    "priority": 10
  }'
```

### 示例2：创建限时公告

```bash
curl -X POST http://localhost:3000/api/announcements \
  -H "Content-Type: application/json" \
  -d '{
    "content": "🔥 双十一活动进行中！",
    "status": 1,
    "priority": 100,
    "start_time": "2025-10-10 00:00:00",
    "end_time": "2025-10-12 23:59:59"
  }'
```

### 示例3：禁用公告

```bash
curl -X PUT http://localhost:3000/api/announcements/1 \
  -H "Content-Type: application/json" \
  -d '{
    "status": 0
  }'
```

### 示例4：批量禁用多个公告

```bash
curl -X POST http://localhost:3000/api/announcements/batch/status \
  -H "Content-Type: application/json" \
  -d '{
    "ids": [1, 2, 3],
    "status": 0
  }'
```

---

## 🛠️ 管理命令

### 初始化公告表

```bash
cd /home/devbox/project/Video
node scripts/createAnnouncementsTable.js
```

### 直接插入公告（SQL）

```sql
-- 插入一条新公告
INSERT INTO announcements (content, status, priority) 
VALUES ('这是一条新公告', 1, 10);

-- 查看所有公告
SELECT * FROM announcements ORDER BY priority DESC;

-- 启用公告
UPDATE announcements SET status = 1 WHERE id = 1;

-- 禁用公告
UPDATE announcements SET status = 0 WHERE id = 1;

-- 删除公告
DELETE FROM announcements WHERE id = 1;
```

---

## 📱 前端实现

### 1. 页面结构（home.wxml）

```xml
<!-- 滚动公告 -->
<view wx:if="{{announcements.length > 0}}" class="announcement-section">
  <view class="announcement-icon">📢</view>
  <swiper 
    class="announcement-swiper" 
    vertical="true" 
    autoplay="true" 
    circular="true" 
    interval="3000" 
    duration="500"
  >
    <block wx:for="{{announcements}}" wx:key="id">
      <swiper-item>
        <view class="announcement-item">{{item.content}}</view>
      </swiper-item>
    </block>
  </swiper>
</view>
```

### 2. 样式定义（home.wxss）

```css
/* 滚动公告 */
.announcement-section {
  width: 100%;
  max-width: 600rpx;
  height: 70rpx;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16rpx;
  display: flex;
  align-items: center;
  padding: 0 24rpx;
  margin-bottom: 40rpx;
  box-shadow: 0 4rpx 12rpx rgba(102, 126, 234, 0.25);
  overflow: hidden;
}
```

### 3. 逻辑处理（home.js）

```javascript
// 加载公告
async loadAnnouncements() {
  try {
    const result = await api.getAnnouncements()
    if (result.code === 200 && result.data) {
      this.setData({
        announcements: result.data
      })
    }
  } catch (error) {
    console.error('加载公告失败:', error)
  }
}
```

---

## 🎯 使用场景

### 1. 系统通知
```
"📢 系统将于今晚22:00进行维护，预计耗时1小时"
```

### 2. 功能更新
```
"🎉 新增支持小红书平台视频解析！"
```

### 3. 活动宣传
```
"🔥 双十一活动进行中！全场功能免费使用！"
```

### 4. 使用提示
```
"💡 温馨提示：请勿用于商业用途，仅供个人学习使用"
```

### 5. 服务状态
```
"⚠️ 部分平台接口异常，我们正在紧急修复中..."
```

---

## 📋 最佳实践

### 1. 内容长度
- ✅ 推荐：30-50字，一行显示完整
- ⚠️ 可用：50-100字，可完整展示
- ❌ 不推荐：超过100字，影响用户体验

### 2. 优先级设置
- **100+**：重要紧急公告（系统维护、重大功能变更）
- **50-99**：重要公告（活动通知、功能上线）
- **10-49**：普通公告（使用提示、温馨提醒）
- **1-9**：次要公告（其他信息）

### 3. 时间控制
- 限时活动：设置 `start_time` 和 `end_time`
- 长期公告：时间字段留空
- 定时发布：设置未来的 `start_time`

### 4. 内容规范
- 使用 emoji 增加视觉吸引力
- 文字简洁明了
- 避免过于冗长
- 突出关键信息

---

## 🔧 故障排查

### 问题1：公告不显示

**可能原因**：
1. 后端服务未启动
2. 数据库连接失败
3. 公告状态为禁用
4. 公告时间不在有效期内

**解决方法**：
```bash
# 1. 检查后端服务
curl http://localhost:3000/api/announcements/active

# 2. 检查数据库
node scripts/createAnnouncementsTable.js

# 3. 查看数据库记录
SELECT * FROM announcements WHERE status = 1;
```

### 问题2：公告滚动不流畅

**解决方法**：
- 调整 `interval` 和 `duration` 参数
- 减少公告数量（建议不超过10条）
- 优化公告内容长度

### 问题3：公告内容超长

**解决方法**：
1. 精简内容
2. 拆分为多条公告
3. 在样式中设置 `text-overflow: ellipsis`

---

## 📊 数据统计

### 查询公告统计

```sql
-- 总公告数
SELECT COUNT(*) as total FROM announcements;

-- 启用公告数
SELECT COUNT(*) as active FROM announcements WHERE status = 1;

-- 今日新增公告
SELECT COUNT(*) as today 
FROM announcements 
WHERE DATE(created_at) = CURDATE();

-- 优先级分布
SELECT 
  CASE 
    WHEN priority >= 100 THEN '高优先级'
    WHEN priority >= 50 THEN '中优先级'
    WHEN priority >= 10 THEN '普通'
    ELSE '低优先级'
  END as level,
  COUNT(*) as count
FROM announcements
WHERE status = 1
GROUP BY level;
```

---

## 🎉 总结

滚动公告功能已成功集成到小程序首页，具备以下优势：

✅ **完全可控** - 通过API接口灵活管理  
✅ **无限制内容** - 支持任意长度文本  
✅ **美观大方** - 现代化UI设计  
✅ **易于使用** - 简单的API接口  
✅ **功能完善** - 优先级、时间控制、状态管理  

---

**文档更新时间**：2025-10-05  
**版本**：v1.0.0
