# 视频下载功能说明

## 功能概述

在小程序内实现视频下载功能，支持将解析的视频直接保存到手机相册。

## 功能特点

### 1. 权限申请 🔐
- 自动请求相册保存权限 (`scope.writePhotosAlbum`)
- 首次使用时弹出授权提示
- 如果用户拒绝，会引导用户去设置页面开启权限
- 已授权用户直接开始下载

### 2. 下载进度显示 📊
- 实时显示下载进度百分比
- 使用 `wx.showLoading` 显示 "下载中 XX%"
- 支持监听下载进度更新

### 3. 下载流程 📥
```
点击"下载视频至本地"
    ↓
检查/请求相册权限
    ↓
开始下载视频 (显示进度)
    ↓
下载完成后保存到相册
    ↓
显示"下载成功"提示
```

### 4. 成功提示 ✅
- 下载并保存成功后弹出 Modal 提示
- 提示内容：**"视频已保存到手机相册"**
- 自动重置下载状态

## 技术实现

### 使用的 API
1. **wx.downloadFile** - 下载视频文件
2. **wx.saveVideoToPhotosAlbum** - 保存视频到相册
3. **wx.getSetting** - 检查权限状态
4. **wx.authorize** - 请求用户授权
5. **wx.openSetting** - 打开设置页面
6. **downloadTask.onProgressUpdate** - 监听下载进度

### 核心代码逻辑

```javascript
// 1. 请求权限
const authorized = await this.requestSaveToPhotosAlbumAuth()

// 2. 下载视频
const downloadTask = wx.downloadFile({
  url: videoInfo.videoUrl,
  success: (res) => {
    // 3. 保存到相册
    wx.saveVideoToPhotosAlbum({
      filePath: res.tempFilePath,
      success: () => {
        // 4. 提示成功
        wx.showModal({
          title: '下载成功',
          content: '视频已保存到手机相册'
        })
      }
    })
  }
})

// 5. 监听进度
downloadTask.onProgressUpdate((progress) => {
  wx.showLoading({
    title: `下载中 ${progress.progress}%`
  })
})
```

## 权限配置

在 `app.json` 中声明权限用途：

```json
{
  "permission": {
    "scope.writePhotosAlbum": {
      "desc": "需要您的授权才能保存视频到相册"
    }
  }
}
```

## 用户体验优化

### 防止重复下载
- 下载中时点击按钮会提示 "视频正在下载中..."
- 使用 `isDownloading` 状态标记

### 错误处理
- 网络错误：提示 "下载失败，请检查网络"
- 权限拒绝：提示 "保存失败：权限被拒绝"
- 保存失败：提示 "保存到相册失败"

### 进度显示
- 实时显示百分比进度
- 下载完成后自动隐藏 loading

## 注意事项

⚠️ **重要提示**

1. **视频格式**
   - 小程序只支持保存特定格式的视频（如 MP4）
   - 视频文件必须可直接访问（非需要特殊处理的 URL）

2. **文件大小**
   - 小程序下载文件有大小限制（默认最大 200MB）
   - 超大视频可能下载失败

3. **权限说明**
   - 首次使用需要用户同意授权
   - 用户拒绝后需要手动在设置中开启

4. **网络环境**
   - 建议在 WiFi 环境下下载
   - 移动网络可能产生流量费用

## 测试要点

✅ **测试场景**

1. 首次下载 - 测试权限申请流程
2. 已授权下载 - 测试直接下载流程
3. 拒绝权限 - 测试引导用户打开设置
4. 下载进度 - 测试进度显示是否正常
5. 下载成功 - 测试保存到相册是否成功
6. 网络异常 - 测试错误提示是否正确
7. 重复下载 - 测试防重复机制

## 未来优化方向

🚀 **可能的改进**

1. 添加自定义进度条组件（更美观的 UI）
2. 支持下载暂停/恢复功能
3. 添加下载历史记录
4. 支持批量下载多个视频
5. 添加下载队列管理
6. 支持选择保存位置（不仅限于相册）

---

**更新时间**: 2025-10-05
**版本**: v1.0.0

