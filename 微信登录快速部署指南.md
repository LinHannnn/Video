# 🚀 微信登录快速部署指南

## ✅ 已完成的工作

所有必要的代码文件已创建完成：

### 后端文件
- ✅ `controllers/authController.js` - 登录控制器（包含手机号解密）
- ✅ `routes/authRoutes.js` - 认证路由配置
- ✅ `middleware/authMiddleware.js` - JWT 认证中间件
- ✅ `scripts/createUsersTable.js` - 数据库表创建脚本
- ✅ `config/wechat.env.example` - 微信配置示例

### 前端文件（小程序）
- ✅ `miniprogram/pages/home/home.js` - 登录逻辑已实现
- ✅ `miniprogram/pages/home/home.wxml` - 登录UI已实现
- ✅ `miniprogram/utils/auth.js` - 认证工具类
- ✅ `miniprogram/utils/api.js` - API 调用封装

## 📋 快速部署步骤

### 第一步：安装依赖（如果还没安装）

```bash
cd /home/devbox/project/Video
npm install jsonwebtoken axios
```

### 第二步：配置微信小程序密钥

1. **获取 AppSecret**：
   - 访问：https://mp.weixin.qq.com/
   - 登录您的小程序账号
   - 进入：开发 → 开发管理 → 开发设置
   - 找到"开发者ID(AppID)" 模块
   - 点击 AppSecret 的"重置"或"查看"按钮
   - 扫码验证后获取 AppSecret

2. **配置到环境变量**：
   ```bash
   # 编辑 .env 文件
   nano .env
   ```
   
   添加以下内容：
   ```env
   # 微信小程序配置
   WX_APPID=wx638ec29150825d0d
   WX_APPSECRET=你获取的AppSecret
   
   # JWT 配置（请修改为随机字符串）
   JWT_SECRET=your-super-secret-jwt-key-change-this
   JWT_EXPIRES_IN=7d
   ```

### 第三步：创建数据库表

```bash
# 运行数据库表创建脚本
node scripts/createUsersTable.js
```

预期输出：
```
📋 开始创建用户表...
✅ 用户表创建成功
✅ 用户登录日志表创建成功
🎉 数据库表创建完成！

📊 当前数据库表:
  - api_keys
  - users
  - user_login_logs
```

### 第四步：启动后端服务

```bash
# 开发环境
npm run dev

# 或生产环境
npm start
```

### 第五步：测试登录接口

#### 测试1：健康检查
```bash
curl http://localhost:3000/api/video/health
```

#### 测试2：测试登录接口结构
```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "loginCode": "test_code_123"
  }'
```

注意：这会返回错误（因为是测试 code），但可以验证接口是否正常运行。

### 第六步：配置微信小程序后台

1. **配置服务器域名**：
   - 登录：https://mp.weixin.qq.com/
   - 进入：开发 → 开发管理 → 开发设置 → 服务器域名
   - 添加 request 合法域名：`https://lhbxbuktfrop.sealoshzh.site`

2. **开通手机号快速验证**：
   - 进入：开发 → 接口设置
   - 找到"手机号快速验证组件"
   - 点击"开通"按钮
   
   ⚠️ 注意：
   - 个人小程序：不支持此功能
   - 企业小程序：需要先认证

### 第七步：测试小程序登录

1. **打开微信开发者工具**
2. **导入小程序项目**（miniprogram 目录）
3. **点击"编译"按钮**
4. **测试登录流程**：
   - 点击首页的"粘贴并解析"按钮
   - 应该弹出登录弹窗
   - 点击"快速登录"或"手机号登录"
   - 查看控制台日志

## 🧪 测试场景

### 场景1：快速登录（不获取手机号）

```javascript
// 小程序端操作
1. 点击"粘贴并解析"按钮
2. 弹出登录弹窗
3. 点击"快速登录"按钮
4. ✅ 应该显示"登录成功"

// 后端日志
🔐 开始登录流程...
📋 loginCode: 071xxx...
📱 phoneCode: 未提供
✅ 获取 openid 成功: oXXXXXXXXXXXX
✅ 用户已存在，更新登录信息
✅ Token 生成成功
🎉 登录流程完成
```

### 场景2：手机号登录

```javascript
// 小程序端操作
1. 点击"粘贴并解析"按钮
2. 弹出登录弹窗
3. 点击"手机号登录"按钮
4. 微信弹出授权弹窗
5. 点击"允许"
6. ✅ 应该显示"登录成功"

// 后端日志
🔐 开始登录流程...
📋 loginCode: 071xxx...
📱 phoneCode: 已提供
✅ 获取 openid 成功: oXXXXXXXXXXXX
📱 开始获取手机号...
🔑 获取新的 access_token...
✅ access_token 获取成功
✅ 手机号获取成功: 138****8000
✅ 用户已存在，更新登录信息
✅ Token 生成成功
🎉 登录流程完成
```

## 🔍 问题排查

### 问题1：提示"缺少登录凭证 loginCode"

**原因**：前端没有正确调用 `wx.login()` 获取 code

**解决**：检查 `miniprogram/utils/auth.js` 的 `getWxLoginCode()` 函数

### 问题2：提示"微信登录失败: invalid code"

**原因**：
- loginCode 已过期（5分钟有效期）
- loginCode 已被使用过
- AppID 或 AppSecret 配置错误

**解决**：
```bash
# 检查环境变量
cat .env | grep WX_

# 应该输出
WX_APPID=wx638ec29150825d0d
WX_APPSECRET=你的AppSecret
```

### 问题3：获取手机号失败

**原因**：
- 小程序未开通手机号快速验证权限
- phoneCode 已过期
- access_token 获取失败

**解决**：
1. 检查小程序是否已开通权限
2. 查看后端日志中的详细错误信息
3. 验证 AppSecret 是否正确

### 问题4：Token 验证失败

**原因**：
- JWT_SECRET 配置不一致
- Token 已过期
- Token 格式错误

**解决**：
```javascript
// 检查请求头格式
headers: {
  'Authorization': 'Bearer ' + token  // 注意 Bearer 后面有空格
}
```

## 📊 数据库表结构

### users 表
```sql
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  openid VARCHAR(100) NOT NULL UNIQUE,
  unionid VARCHAR(100) DEFAULT NULL,
  phone VARCHAR(20) DEFAULT NULL,
  nickname VARCHAR(100) DEFAULT NULL,
  avatar_url VARCHAR(500) DEFAULT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_login_time TIMESTAMP,
  login_count INT DEFAULT 0,
  status TINYINT DEFAULT 1
);
```

### user_login_logs 表（可选）
```sql
CREATE TABLE user_login_logs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  login_type ENUM('wechat', 'phone', 'guest'),
  ip_address VARCHAR(50),
  device_info TEXT
);
```

## 🔒 安全建议

### 1. 保护敏感信息
```bash
# 确保 .env 文件不被提交到 Git
echo ".env" >> .gitignore
```

### 2. 使用强随机密钥
```bash
# 生成随机 JWT_SECRET
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 3. 设置合理的 Token 过期时间
```env
# 短期应用：1天
JWT_EXPIRES_IN=1d

# 常规应用：7天
JWT_EXPIRES_IN=7d

# 长期应用：30天
JWT_EXPIRES_IN=30d
```

### 4. 启用 HTTPS
- 开发环境：可以使用 HTTP
- 生产环境：必须使用 HTTPS

## 📡 API 接口文档

### POST /auth/login
**功能**：微信登录（支持手机号快速验证）

**请求**：
```json
{
  "loginCode": "071xxx...",  // 必填：wx.login() 获取的 code
  "phoneCode": "abc123..."   // 可选：getPhoneNumber 获取的 code
}
```

**响应（成功）**：
```json
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "openid": "oXXXXXXXXXXXXXXXXX",
    "phone": "13800138000",
    "userId": 123
  }
}
```

### GET /auth/userinfo
**功能**：获取当前用户信息

**请求头**：
```
Authorization: Bearer <token>
```

**响应**：
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "id": 123,
    "openid": "oXXXXXXXXXXXXXXXXX",
    "phone": "13800138000",
    "created_at": "2025-01-01T00:00:00.000Z",
    "last_login_time": "2025-01-05T10:30:00.000Z",
    "login_count": 5
  }
}
```

## 🎉 完成检查清单

完成以下检查，确保所有配置正确：

- [ ] 安装了 `jsonwebtoken` 和 `axios` 依赖
- [ ] 配置了 `WX_APPID` 和 `WX_APPSECRET`
- [ ] 配置了 `JWT_SECRET`（使用随机字符串）
- [ ] 运行了 `createUsersTable.js` 创建数据库表
- [ ] 后端服务启动成功
- [ ] 微信小程序配置了服务器域名
- [ ] 企业小程序开通了手机号快速验证权限
- [ ] 测试了快速登录功能
- [ ] 测试了手机号登录功能
- [ ] 验证了 Token 认证功能

## 💡 下一步

完成登录功能后，您可以：

1. **添加用户信息管理**：
   - 修改昵称
   - 更新头像
   - 绑定手机号

2. **实现会员功能**：
   - VIP 会员系统
   - 积分系统
   - 邀请奖励

3. **增强安全性**：
   - 添加刷新 Token 机制
   - 实现 Token 黑名单
   - 添加设备指纹验证

4. **数据分析**：
   - 用户活跃度统计
   - 登录行为分析
   - 留存率分析

## 📞 获取帮助

如遇到问题，请检查：

1. **后端日志**：`logs/combined.log` 和 `logs/error.log`
2. **小程序控制台**：微信开发者工具的 Console 面板
3. **网络请求**：开发者工具的 Network 面板

常见日志输出：
```
🔐 开始登录流程...
📋 loginCode: 071xxx...
📱 phoneCode: 已提供/未提供
✅ 获取 openid 成功: oXXXXXX
✅ Token 生成成功
🎉 登录流程完成
```

祝您部署顺利！🎊
